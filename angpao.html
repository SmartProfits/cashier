<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á∫¢ÂåÖÊäΩÂ•ñ</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        h2 {
            color: #e74c3c;
            margin-bottom: 25px;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        input {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e74c3c;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: #c0392b;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
        }

        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 15px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
        }

        button:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        .hidden {
            display: none;
        }

        .result {
            font-size: 28px;
            color: #e74c3c;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(231, 76, 60, 0.1);
            animation: fadeIn 0.5s ease;
        }

        .remaining {
            font-size: 16px;
            color: #7f8c8d;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .red-packet {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23e74c3c" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>') no-repeat center;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Êñ∞Â¢ûÂêçÂçïÊ†∑Âºè */
        .layout {
            display: flex;
            gap: 20px;
            max-width: 1000px;
            width: 95%;
            margin: 0 auto;
        }

        .winners-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .winner-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }
            .winners-list {
                width: auto;
                max-height: 300px;
            }
        }

        .status-info {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #e74c3c;
        }

        /* Ê∑ªÂä†ÊäΩÂ•ñÂä®ÁîªÁõ∏ÂÖ≥Ê†∑Âºè */
        .lottery-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .rolling-number {
            font-size: 72px;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            margin-bottom: 20px;
            transition: transform 0.1s ease;
        }

        .drum-roll {
            font-size: 24px;
            color: #fff;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .shaking {
            animation: shake 0.1s ease-in-out infinite;
        }

        @keyframes shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-1px, 1px) rotate(-1deg); }
            50% { transform: translate(1px, -1px) rotate(1deg); }
            75% { transform: translate(-1px, -1px) rotate(-1deg); }
            100% { transform: translate(1px, 1px) rotate(1deg); }
        }

        .share-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            text-align: center;
        }

        .share-section h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .share-link {
            word-break: break-all;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }

        .qr-code {
            margin: 15px auto;
        }

        .copy-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #27ae60;
        }

        .admin-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .admin-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: #2980b9;
        }

        .status-info div {
            margin: 5px 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .name-select {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e74c3c;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background-color: white;
            cursor: pointer;
        }

        .name-select:focus {
            border-color: #c0392b;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
        }

        .name-select option {
            padding: 10px;
            font-size: 16px;
        }
    </style>
    <!-- Ê∑ªÂä†QRÁ†ÅÁîüÊàêÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <!-- Âú®</head>ÂâçÊ∑ªÂä†Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBO5zgKEHDE4hkVdWOVVpcpodB7Sl1UUro",
        authDomain: "angpao-da62f.firebaseapp.com",
        databaseURL: "https://angpao-da62f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "angpao-da62f",
        storageBucket: "angpao-da62f.firebasestorage.app",
        messagingSenderId: "303412944902",
        appId: "1:303412944902:web:0e9c30451c4cc37258a387",
        measurementId: "G-WDX94CKZ1Q"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Â∞ÜFirebaseÂÆû‰æãÊö¥Èú≤ÁªôÂÖ®Â±Ä‰ΩúÁî®Âüü
      window.db = db;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbPush = push;
      window.dbOnValue = onValue;
      window.dbGet = get;
      window.dbChild = child;

      // Ê∑ªÂä†ÂàùÂßãÂåñÂÆåÊàêÁöÑÊ†áÂøó
      window.firebaseInitialized = true;
      
      // Ëß¶ÂèëÂàùÂßãÂåñÂÆåÊàê‰∫ã‰ª∂
      const event = new Event('firebaseInitialized');
      window.dispatchEvent(event);
    </script>
</head>
<body>
    <div class="layout">
        <div class="container">
            <div id="adminPanel">
                <h2>üßß Red Packet Management</h2>
                <input type="text" id="setPassword" placeholder="Set Access Password">
                <button onclick="setupGame()">Confirm Settings</button>
            </div>

            <div id="userPanel" class="hidden">
                <div class="red-packet"></div>
                <h2>üéâ Red Packet Lucky Draw</h2>
                <div class="status-info" id="participantStatus"></div>
                <input type="text" id="password" placeholder="Please Enter Password">
                <button onclick="checkPassword()">Start Lucky Draw</button>
            </div>

            <div id="lotteryPanel" class="hidden">
                <div class="red-packet"></div>
                <h2>üéä Lucky Draw Panel</h2>
                <div class="status-info" id="lotteryStatus"></div>
                <select id="userName" class="name-select">
                    <option value="">Please Select Your Name</option>
                    <option value="Anna">Anna</option>
                    <option value="Khalila">Khalila</option>
                    <option value="BIBI">BIBI</option>
                    <option value="Aisyah">Aisyah</option>
                    <option value="Aisyah (M)">Aisyah (M)</option>
                    <option value="Nuha">Nuha</option>
                    <option value="Shafiqah">Shafiqah</option>
                    <option value="Aina">Aina</option>
                    <option value="Aliyyah">Aliyyah</option>
                    <option value="Mashita">Mashita</option>
                    <option value="Syalieza">Syalieza</option>
                </select>
                <button onclick="drawLottery()">Draw Now</button>
                <div id="result" class="result"></div>
            </div>

            <!-- Ê∑ªÂä†ÂàÜ‰∫´ÈÉ®ÂàÜ -->
            <div id="shareSection" class="share-section hidden">
                <h3>Share Link</h3>
                <div class="share-link" id="shareLink"></div>
                <button class="copy-btn" onclick="copyLink()">Copy Link</button>
                <div id="qrcode" class="qr-code"></div>
            </div>

            <!-- Âú®container div‰∏≠Ê∑ªÂä†Êñ∞ÁöÑÁÆ°ÁêÜÂëòÊü•ÁúãÈù¢Êùø -->
            <div id="adminViewPanel" class="hidden">
                <h2>üéÆ Admin Control Panel</h2>
                <div class="status-info">
                    <div>Total Amount: RM <span id="totalAmountDisplay">0</span></div>
                    <div>Remaining Amount: RM <span id="remainingAmountDisplay">0</span></div>
                    <div>Participants: <span id="participantCountDisplay">0</span> / <span id="maxParticipantsDisplay">0</span></div>
                </div>
                <div class="admin-controls">
                    <button onclick="closeGame()" class="admin-btn">End Game</button>
                    <button onclick="exportResults()" class="admin-btn">Export Results</button>
                </div>
            </div>
        </div>

        <div class="winners-list hidden" id="winnersList">
            <h2>üèÜ Winners List</h2>
            <div id="winnersContainer"></div>
        </div>
    </div>

    <script>
        // Á≠âÂæÖ Firebase ÂàùÂßãÂåñ
        window.addEventListener('firebaseInitialized', () => {
            console.log('Firebase initialized, setting up page...');
            // Ê£ÄÊü• URL ‰∏≠ÊòØÂê¶ÊúâÊ∏∏Êàè ID
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (gameId) {
                console.log('Found game ID in URL:', gameId);
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('winnersList').classList.remove('hidden');
                initializeGameListeners(gameId);
            }
        });

        let gamePassword = '';
        let totalAmount = 0;
        let remainingAmount = 0;
        let participants = [];
        let maxParticipants = 0;
        const MIN_AMOUNT = 10; // ËÆæÁΩÆÊúÄ‰ΩéÈáëÈ¢ù‰∏∫10

        function updateStatus() {
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (!gameId) return;

            const gameRef = window.dbRef(window.db, `games/${gameId}`);
            window.dbGet(gameRef).then(snapshot => {
                const gameData = snapshot.val();
                if (!gameData) return;

                const remainingSpots = gameData.maxParticipants - (gameData.participants ? gameData.participants.length : 0);
                const participantStatus = document.getElementById('participantStatus');
                const lotteryStatus = document.getElementById('lotteryStatus');
                const statusText = `Remaining Spots: ${remainingSpots} / Total: ${gameData.maxParticipants}`;
                
                if (participantStatus) {
                    participantStatus.innerHTML = statusText;
                }
                if (lotteryStatus) {
                    lotteryStatus.innerHTML = statusText;
                }
            });
        }

        async function setupGame() {
            if (!window.db || !window.dbRef || !window.dbSet || !window.dbPush) {
                console.error('Firebase functions not available');
                alert('Please wait for system initialization and try again.');
                return;
            }

            try {
                const password = document.getElementById('setPassword').value;

                if (!password) {
                    alert('Please set a password!');
                    return;
                }

                // ÂàõÂª∫Êñ∞Ê∏∏Êàè
                const gamesRef = window.dbRef(window.db, 'games');
                const newGameRef = window.dbPush(gamesRef);
                const gameId = newGameRef.key;

                const gameData = {
                    totalAmount: 220,          // Âõ∫ÂÆöÊÄªÈáëÈ¢ù
                    remainingAmount: 220,      // ÂàùÂßãÂâ©‰ΩôÈáëÈ¢ù
                    gamePassword: password,
                    maxParticipants: 11,       // Âõ∫ÂÆöÂèÇ‰∏é‰∫∫Êï∞
                    participants: [],
                    winners: [],
                    createdAt: Date.now(),
                    isActive: true
                };

                await window.dbSet(newGameRef, gameData);

                // ‰øùÂ≠òÁÆ°ÁêÜÂëòÂØÜÁ†Å
                localStorage.setItem(`admin_${gameId}`, password);

                // Êõ¥Êñ∞ URL
                window.history.pushState({}, '', `?game=${gameId}`);

                // Êõ¥Êñ∞ÁïåÈù¢
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('winnersList').classList.remove('hidden');
                document.getElementById('adminViewPanel').classList.remove('hidden');

                // ÂàùÂßãÂåñÂÖ∂‰ªñÂäüËÉΩ
                showShareSection();
                updateStatus();
                initializeGameListeners(gameId);
                updateAdminView(gameId);

                alert('Game setup successful!');

            } catch (error) {
                console.error('Setup game error:', error);
                alert('Error: ' + error.message);
            }
        }

        function initializeGameListeners(gameId) {
            try {
                console.log('Initializing game listeners for ID:', gameId);
                if (!gameId) {
                    console.error('No game ID provided');
                    return;
                }

                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                
                window.dbOnValue(gameRef, (snapshot) => {
                    const gameData = snapshot.val();
                    console.log('Game data received:', gameData);
                    
                    if (!gameData) {
                        console.log('No game data found');
                        return;
                    }

                    // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
                    window.totalAmount = gameData.totalAmount || 0;
                    window.remainingAmount = gameData.remainingAmount || 0;
                    window.gamePassword = gameData.gamePassword || '';
                    window.maxParticipants = gameData.maxParticipants || 0;
                    window.participants = gameData.participants || [];

                    // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                    updateStatus();

                    // Êõ¥Êñ∞‰∏≠Â•ñÂêçÂçï
                    updateWinnersList(gameData.winners || []);
                    
                    // ÊòæÁ§∫‰∏≠Â•ñÂêçÂçïÂå∫Âüü
                    document.getElementById('winnersList').classList.remove('hidden');

                    console.log('Game state updated:', {
                        maxParticipants: gameData.maxParticipants,
                        currentParticipants: gameData.participants ? gameData.participants.length : 0,
                        remainingSpots: gameData.maxParticipants - (gameData.participants ? gameData.participants.length : 0)
                    });
                });
            } catch (error) {
                console.error('Initialize listeners error:', error);
                alert('Error initializing game listeners: ' + error.message);
            }
        }

        async function checkPassword() {
            try {
                const gameId = new URLSearchParams(window.location.search).get('game');
                if (!gameId) {
                    alert('Êó†ÊïàÁöÑÊ∏∏ÊàèIDÔºÅ');
                    return;
                }

                const inputPassword = document.getElementById('password').value;
                if (!inputPassword) {
                    alert('ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÔºÅ');
                    return;
                }

                // Ëé∑ÂèñÊ∏∏ÊàèÊï∞ÊçÆ
                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                const snapshot = await window.dbGet(gameRef);
                const gameData = snapshot.val();

                console.log('Game data:', gameData); // Ë∞ÉËØï‰ø°ÊÅØ

                if (!gameData) {
                    alert('Ê∏∏Êàè‰∏çÂ≠òÂú®ÔºÅ');
                    return;
                }

                if (gameData.isActive === false) {
                    alert('ËØ•Ê∏∏ÊàèÂ∑≤ÁªìÊùüÔºÅ');
                    return;
                }

                if (inputPassword === gameData.gamePassword) {
                    document.getElementById('userPanel').classList.add('hidden');
                    document.getElementById('lotteryPanel').classList.remove('hidden');
                    document.getElementById('winnersList').classList.remove('hidden');
                    updateStatus();
                } else {
                    alert('ÂØÜÁ†ÅÈîôËØØÔºÅ');
                }
            } catch (error) {
                console.error('Check password error:', error);
                alert('È™åËØÅÂØÜÁ†ÅÊó∂Âá∫ÈîôÔºö' + error.message);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function showLotteryAnimation(finalAmount) {
            // ÂàõÂª∫Âä®ÁîªÂÆπÂô®
            const animationContainer = document.createElement('div');
            animationContainer.className = 'lottery-animation';
            
            const numberDisplay = document.createElement('div');
            numberDisplay.className = 'rolling-number';
            
            const drumRoll = document.createElement('div');
            drumRoll.className = 'drum-roll';
            drumRoll.textContent = 'ÊäΩÂ•ñ‰∏≠...';
            
            animationContainer.appendChild(numberDisplay);
            animationContainer.appendChild(drumRoll);
            document.body.appendChild(animationContainer);

            // ‰øÆÊîπÈöèÊú∫Êï∞ÁîüÊàêÂáΩÊï∞
            const getRandomAmount = () => {
                const amounts = [10, 15, 20, 25, 30, 35, 40, 45, 50]; // ÊúÄ‰Ωé‰ªé10ÂºÄÂßã
                return amounts[Math.floor(Math.random() * amounts.length)];
            };

            // Âä®ÁîªÂèÇÊï∞
            const totalDuration = 3000; // ÊÄªÊåÅÁª≠Êó∂Èó¥
            const startTime = Date.now();
            let lastUpdateTime = startTime;

            // Âä®ÁîªÂæ™ÁéØ
            return new Promise(resolve => {
                const animate = () => {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    
                    // Ê†πÊçÆÊó∂Èó¥Êé®ÁßªË∞ÉÊï¥Êõ¥Êñ∞È¢ëÁéáÂíåÊòæÁ§∫ÊïàÊûú
                    if (currentTime - lastUpdateTime > (elapsed / totalDuration) * 100) {
                        // ÁîüÊàêÈöèÊú∫Êï∞
                        let displayAmount;
                        
                        if (elapsed < totalDuration * 0.7) {
                            // Ââç70%Êó∂Èó¥ÔºåÂÆåÂÖ®ÈöèÊú∫
                            displayAmount = getRandomAmount();
                        } else if (elapsed < totalDuration * 0.9) {
                            // 70%-90%Êó∂Èó¥ÔºåÂú®ÊúÄÁªàÈáëÈ¢ùÈôÑËøëÊ≥¢Âä®
                            const variance = Math.max(5, Math.floor((totalDuration - elapsed) / 100));
                            displayAmount = finalAmount + (Math.random() - 0.5) * variance * 2;
                            displayAmount = Math.round(displayAmount / 5) * 5;
                        } else {
                            // ÊúÄÂêé10%Êó∂Èó¥ÔºåÈÄêÊ∏êÁ®≥ÂÆöÂà∞ÊúÄÁªàÈáëÈ¢ù
                            displayAmount = finalAmount;
                        }

                        // Ê∑ªÂä†ËßÜËßâÊïàÊûú
                        const fontSize = Math.min(100, 60 + Math.random() * 40);
                        const hue = Math.floor(Math.random() * 360);
                        
                        numberDisplay.style.fontSize = `${fontSize}px`;
                        numberDisplay.style.color = `hsl(${hue}, 70%, 50%)`;
                        numberDisplay.style.transform = `scale(${1 + Math.random() * 0.2})`;
                        numberDisplay.textContent = `RM ${displayAmount}`;
                        
                        lastUpdateTime = currentTime;
                    }

                    if (elapsed < totalDuration) {
                        requestAnimationFrame(animate);
                    } else {
                        // Âä®ÁîªÁªìÊùüÔºåÊòæÁ§∫ÊúÄÁªàÈáëÈ¢ù
                        numberDisplay.style.fontSize = '96px';
                        numberDisplay.style.color = '#f1c40f';
                        numberDisplay.style.transform = 'scale(1.1)';
                        numberDisplay.textContent = `RM ${finalAmount}`;
                        drumRoll.textContent = 'ÊÅ≠ÂñúÔºÅ';
                        
                        // Á≠âÂæÖ‰∏Ä‰ºöÂêéÁßªÈô§Âä®Áîª
                        setTimeout(() => {
                            animationContainer.style.animation = 'fadeOut 0.3s ease';
                            setTimeout(() => {
                                document.body.removeChild(animationContainer);
                                resolve();
                            }, 300);
                        }, 1500);
                    }
                };

                requestAnimationFrame(animate);
            });
        }

        function calculatePrizeAmount(remainingAmount, remainingPeople, gameData) {
            // È¢ÑËÆæÁöÑÁâπÂÆöÈáëÈ¢ùÂàÜÁªÑ
            const PRIZE_GROUPS = {
                '50': 1,  // 1‰∏™50ÂÖÉÂ•ñ
                '30': 2,  // 2‰∏™30ÂÖÉÂ•ñ
                '20': 3,  // 3‰∏™20ÂÖÉÂ•ñ
                '10': 5   // 5‰∏™10ÂÖÉÂ•ñ
            };
            
            // Ëé∑ÂèñÂ∑≤ÁªèÊäΩ‰∏≠ÁöÑÈáëÈ¢ùÂàóË°®
            const existingAmounts = (gameData.winners || []).map(w => w.amount);
            
            // ÁªüËÆ°ÊØè‰∏™ÈáëÈ¢ùÂ∑≤Ë¢´ÊäΩÂèñÁöÑÊ¨°Êï∞
            const amountCounts = existingAmounts.reduce((acc, amount) => {
                acc[amount] = (acc[amount] || 0) + 1;
                return acc;
            }, {});
            
            // ÊâæÂá∫ËøòÂèØ‰ª•ÊäΩÂèñÁöÑÈáëÈ¢ù
            const availableAmounts = Object.entries(PRIZE_GROUPS)
                .filter(([amount, limit]) => {
                    const currentCount = amountCounts[amount] || 0;
                    return currentCount < limit;
                })
                .map(([amount]) => parseInt(amount));
            
            if (availableAmounts.length === 0) {
                console.error('No available amounts left!');
                return 0;
            }
            
            // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂèØÁî®ÈáëÈ¢ù
            const randomIndex = Math.floor(Math.random() * availableAmounts.length);
            return availableAmounts[randomIndex];
        }

        async function drawLottery() {
            try {
                const gameId = new URLSearchParams(window.location.search).get('game');
                if (!gameId) {
                    alert('Êó†ÊïàÁöÑÊ∏∏ÊàèIDÔºÅ');
                    return;
                }

                const name = document.getElementById('userName').value;
                if (!name) {
                    alert('ËØ∑ÈÄâÊã©ÊÇ®ÁöÑÂêçÂ≠óÔºÅ');
                    return;
                }

                // Ëé∑ÂèñÊúÄÊñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                const snapshot = await window.dbGet(gameRef);
                const gameData = snapshot.val();

                if (!gameData) {
                    alert('Ê∏∏Êàè‰∏çÂ≠òÂú®ÔºÅ');
                    return;
                }

                if (gameData.participants && gameData.participants.includes(name)) {
                    alert('ÊÇ®Â∑≤ÁªèÂèÇ‰∏éËøáÊäΩÂ•ñ‰∫ÜÔºÅ');
                    return;
                }

                if (gameData.participants && gameData.participants.length >= gameData.maxParticipants) {
                    alert('ÊäΩÂ•ñ‰∫∫Êï∞Â∑≤Ëææ‰∏äÈôêÔºÅ');
                    return;
                }

                // ËÆ°ÁÆóÂâ©‰Ωô‰∫∫Êï∞ÂíåÈáëÈ¢ù
                const remainingPeople = gameData.maxParticipants - (gameData.participants ? gameData.participants.length : 0) - 1;
                const remainingAmount = gameData.remainingAmount;

                console.log('ÊäΩÂ•ñ‰ø°ÊÅØÔºö', {
                    remainingAmount: remainingAmount,
                    remainingPeople: remainingPeople,
                    currentParticipants: gameData.participants ? gameData.participants.length : 0
                });

                let amount = calculatePrizeAmount(remainingAmount, remainingPeople, gameData);

                // Êí≠ÊîæÂä®Áîª
                await showLotteryAnimation(amount);

                // Êõ¥Êñ∞Ê∏∏ÊàèÁä∂ÊÄÅ
                const newParticipants = gameData.participants ? [...gameData.participants, name] : [name];
                const newWinners = gameData.winners ? [...gameData.winners] : [];
                newWinners.push({
                    name: name,
                    amount: amount,
                    timestamp: Date.now()
                });
                
                await window.dbSet(gameRef, {
                    ...gameData,
                    remainingAmount: remainingAmount - amount,
                    participants: newParticipants,
                    winners: newWinners
                });

                // Êõ¥Êñ∞ÊòæÁ§∫
                updateWinnersList(newWinners);
                document.getElementById('result').textContent = `ÊÅ≠ÂñúËé∑Âæó RM ${amount}!`;
                
            } catch (error) {
                console.error('Draw lottery error:', error);
                alert('ÊäΩÂ•ñËøáÁ®ã‰∏≠Âá∫ÈîôÔºö' + error.message);
            }
        }

        function updateWinnersList(winners) {
            const winnersContainer = document.getElementById('winnersContainer');
            const winnersList = document.getElementById('winnersList');
            
            // Á°Æ‰øù‰∏≠Â•ñÂêçÂçïÂÆπÂô®ÂèØËßÅ
            winnersList.classList.remove('hidden');
            winnersContainer.innerHTML = '';
            
            if (!winners || winners.length === 0) {
                winnersContainer.innerHTML = '<div class="winner-item">ÊöÇÊó†‰∏≠Â•ñËÆ∞ÂΩï</div>';
                return;
            }
            
            // ÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂàó‰∏≠Â•ñËÆ∞ÂΩï
            winners.sort((a, b) => b.timestamp - a.timestamp).forEach(winner => {
                const winnerItem = document.createElement('div');
                winnerItem.className = 'winner-item';
                winnerItem.innerHTML = `
                    <span>${winner.name}</span>
                    <span>RM ${winner.amount}</span>
                `;
                winnersContainer.appendChild(winnerItem);
            });
        }

        function showShareSection() {
            const shareSection = document.getElementById('shareSection');
            const shareLinkDiv = document.getElementById('shareLink');
            const qrcodeDiv = document.getElementById('qrcode');
            
            // Ëé∑ÂèñÂΩìÂâçÈ°µÈù¢URL
            const currentUrl = window.location.href;
            
            // ÊòæÁ§∫ÈìæÊé•
            shareLinkDiv.textContent = currentUrl;
            shareSection.classList.remove('hidden');
            
            // ÁîüÊàê‰∫åÁª¥Á†Å
            qrcodeDiv.innerHTML = ''; // Ê∏ÖÈô§‰πãÂâçÁöÑ‰∫åÁª¥Á†Å
            new QRCode(qrcodeDiv, {
                text: currentUrl,
                width: 128,
                height: 128,
                colorDark : "#e74c3c",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function copyLink() {
            const shareLinkDiv = document.getElementById('shareLink');
            const text = shareLinkDiv.textContent;
            
            // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
            navigator.clipboard.writeText(text).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.textContent = 'Â∑≤Â§çÂà∂ÔºÅ';
                copyBtn.style.background = '#e74c3c';
                
                setTimeout(() => {
                    copyBtn.textContent = 'Â§çÂà∂ÈìæÊé•';
                    copyBtn.style.background = '#2ecc71';
                }, 2000);
            }).catch(err => {
                alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂ÈìæÊé•');
            });
        }

        // Ê∑ªÂä†ÁÆ°ÁêÜÂëòËßÜÂõæÊõ¥Êñ∞ÂáΩÊï∞
        function updateAdminView(gameId) {
            const gameRef = window.dbRef(window.db, `games/${gameId}`);
            
            window.dbOnValue(gameRef, (snapshot) => {
                const gameData = snapshot.val();
                if (!gameData) return;

                // Êõ¥Êñ∞ÊòæÁ§∫
                document.getElementById('totalAmountDisplay').textContent = gameData.totalAmount;
                document.getElementById('remainingAmountDisplay').textContent = gameData.remainingAmount;
                document.getElementById('participantCountDisplay').textContent = 
                    gameData.participants ? gameData.participants.length : 0;
                document.getElementById('maxParticipantsDisplay').textContent = gameData.maxParticipants;
            });
        }

        // Ê∑ªÂä†ÁªìÊùüÊ∏∏ÊàèÂäüËÉΩ
        async function closeGame() {
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (!gameId) return;

            const adminPassword = localStorage.getItem(`admin_${gameId}`);
            const inputPassword = prompt('ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÁ†Å‰ª•ÁªìÊùüÊ∏∏ÊàèÔºö');
            
            if (inputPassword !== adminPassword) {
                alert('ÂØÜÁ†ÅÈîôËØØÔºÅ');
                return;
            }

            try {
                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                await window.dbSet(gameRef, {
                    isActive: false
                }, { merge: true });
                alert('Ê∏∏ÊàèÂ∑≤ÁªìÊùüÔºÅ');
            } catch (error) {
                console.error('Close game error:', error);
                alert('ÁªìÊùüÊ∏∏ÊàèÊó∂Âá∫ÈîôÔºö' + error.message);
            }
        }

        // Ê∑ªÂä†ÂØºÂá∫ÁªìÊûúÂäüËÉΩ
        function exportResults() {
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (!gameId) return;

            const adminPassword = localStorage.getItem(`admin_${gameId}`);
            const inputPassword = prompt('ËØ∑ËæìÂÖ•ÁÆ°ÁêÜÂëòÂØÜÁ†Å‰ª•ÂØºÂá∫ÁªìÊûúÔºö');
            
            if (inputPassword !== adminPassword) {
                alert('ÂØÜÁ†ÅÈîôËØØÔºÅ');
                return;
            }

            const gameRef = window.dbRef(window.db, `games/${gameId}`);
            window.dbGet(gameRef).then((snapshot) => {
                const gameData = snapshot.val();
                if (!gameData) return;

                const winners = gameData.winners || [];
                let csv = 'ÂêçÂ≠ó,ÈáëÈ¢ù,Êó∂Èó¥\n';
                
                winners.forEach(winner => {
                    const date = new Date(winner.timestamp).toLocaleString();
                    csv += `${winner.name},${winner.amount},${date}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ÊäΩÂ•ñÁªìÊûú_${new Date().toLocaleDateString()}.csv`;
                a.click();
            });
        }
    </script>
</body>
</html>
