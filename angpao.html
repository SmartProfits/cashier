<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢åŒ…æŠ½å¥–</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        h2 {
            color: #e74c3c;
            margin-bottom: 25px;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        input {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e74c3c;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: #c0392b;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
        }

        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 15px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
        }

        button:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        .hidden {
            display: none;
        }

        .result {
            font-size: 28px;
            color: #e74c3c;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(231, 76, 60, 0.1);
            animation: fadeIn 0.5s ease;
        }

        .remaining {
            font-size: 16px;
            color: #7f8c8d;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .red-packet {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23e74c3c" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>') no-repeat center;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* æ–°å¢åå•æ ·å¼ */
        .layout {
            display: flex;
            gap: 20px;
            max-width: 1000px;
            width: 95%;
            margin: 0 auto;
        }

        .winners-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .winner-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }
            .winners-list {
                width: auto;
                max-height: 300px;
            }
        }

        .status-info {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #e74c3c;
        }

        /* æ·»åŠ æŠ½å¥–åŠ¨ç”»ç›¸å…³æ ·å¼ */
        .lottery-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .rolling-number {
            font-size: 72px;
            color: #e74c3c;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .drum-roll {
            font-size: 24px;
            color: #fff;
            margin-top: 20px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .shaking {
            animation: shake 0.1s infinite;
        }

        .share-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            text-align: center;
        }

        .share-section h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .share-link {
            word-break: break-all;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }

        .qr-code {
            margin: 15px auto;
        }

        .copy-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #27ae60;
        }
    </style>
    <!-- æ·»åŠ QRç ç”Ÿæˆåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <!-- åœ¨</head>å‰æ·»åŠ Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBO5zgKEHDE4hkVdWOVVpcpodB7Sl1UUro",
        authDomain: "angpao-da62f.firebaseapp.com",
        databaseURL: "https://angpao-da62f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "angpao-da62f",
        storageBucket: "angpao-da62f.firebasestorage.app",
        messagingSenderId: "303412944902",
        appId: "1:303412944902:web:0e9c30451c4cc37258a387",
        measurementId: "G-WDX94CKZ1Q"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // å°†Firebaseå®ä¾‹æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸ
      window.db = db;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbPush = push;
      window.dbOnValue = onValue;
      window.dbGet = get;
      window.dbChild = child;
    </script>
</head>
<body>
    <div class="layout">
        <div class="container">
            <div id="adminPanel">
                <h2>ğŸ§§ çº¢åŒ…ç®¡ç†è®¾ç½®</h2>
                <input type="number" id="totalAmount" placeholder="è®¾ç½®æ€»é‡‘é¢ (RM)">
                <input type="number" id="maxParticipants" placeholder="è®¾ç½®æŠ½å¥–äººæ•°">
                <input type="password" id="setPassword" placeholder="è®¾ç½®è®¿é—®å¯†ç ">
                <button onclick="setupGame()">ç¡®è®¤è®¾ç½®</button>
            </div>

            <div id="userPanel" class="hidden">
                <div class="red-packet"></div>
                <h2>ğŸ‰ çº¢åŒ…æŠ½å¥–</h2>
                <div class="status-info" id="participantStatus"></div>
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                <button onclick="checkPassword()">å¼€å§‹æŠ½å¥–</button>
            </div>

            <div id="lotteryPanel" class="hidden">
                <div class="red-packet"></div>
                <h2>ğŸŠ æŠ½å¥–é¢æ¿</h2>
                <div class="status-info" id="lotteryStatus"></div>
                <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„åå­—">
                <button onclick="drawLottery()">ç«‹å³æŠ½å¥–</button>
                <div id="result" class="result"></div>
            </div>

            <!-- æ·»åŠ åˆ†äº«éƒ¨åˆ† -->
            <div id="shareSection" class="share-section hidden">
                <h3>åˆ†äº«é“¾æ¥</h3>
                <div class="share-link" id="shareLink"></div>
                <button class="copy-btn" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
                <div id="qrcode" class="qr-code"></div>
            </div>
        </div>

        <div class="winners-list hidden" id="winnersList">
            <h2>ğŸ† ä¸­å¥–åå•</h2>
            <div id="winnersContainer"></div>
        </div>
    </div>

    <script>
        let gamePassword = '';
        let totalAmount = 0;
        let remainingAmount = 0;
        let participants = [];
        let maxParticipants = 0;
        const MIN_AMOUNT = 10; // è®¾ç½®æœ€ä½é‡‘é¢ä¸º10

        function updateStatus() {
            const remainingSpots = maxParticipants - participants.length;
            const participantStatus = document.getElementById('participantStatus');
            const lotteryStatus = document.getElementById('lotteryStatus');
            const statusText = `å‰©ä½™åé¢: ${remainingSpots} / æ€»äººæ•°: ${maxParticipants}`;
            
            if (participantStatus) {
                participantStatus.innerHTML = statusText;
            }
            if (lotteryStatus) {
                lotteryStatus.innerHTML = statusText;
            }
        }

        async function setupGame() {
            console.log('Setup game started');
            console.log('Amount:', document.getElementById('totalAmount').value);
            console.log('Password:', document.getElementById('setPassword').value);
            console.log('Participants:', document.getElementById('maxParticipants').value);

            try {
                const amount = document.getElementById('totalAmount').value;
                const password = document.getElementById('setPassword').value;
                const participants = document.getElementById('maxParticipants').value;
                
                if (!amount || !password || !participants) {
                    alert('è¯·å¡«å†™æ‰€æœ‰è®¾ç½®é¡¹ï¼');
                    return;
                }

                if (amount % 5 !== 0) {
                    alert('è¯·è¾“å…¥5çš„å€æ•°é‡‘é¢ï¼');
                    return;
                }

                if (participants < 1) {
                    alert('å‚ä¸äººæ•°å¿…é¡»å¤§äº0ï¼');
                    return;
                }

                // ç¡®ä¿æ€»é‡‘é¢è¶³å¤Ÿæ¯äººè‡³å°‘åˆ†åˆ°10å…ƒ
                if (amount < participants * MIN_AMOUNT) {
                    alert(`æ€»é‡‘é¢å¿…é¡»è‡³å°‘èƒ½ä¿è¯æ¯äººè·å¾—${MIN_AMOUNT}å…ƒï¼`);
                    return;
                }

                // åˆ›å»ºæ–°æ¸¸æˆ
                const gameRef = dbPush(dbRef(db, 'games'));
                const gameId = gameRef.key;
                console.log('Game ID created:', gameId); // è°ƒè¯•ä¿¡æ¯
                
                await dbSet(gameRef, {
                    totalAmount: parseFloat(amount),
                    remainingAmount: parseFloat(amount),
                    gamePassword: password,
                    maxParticipants: parseInt(participants),
                    participants: [],
                    winners: [],
                    createdAt: Date.now()
                }).then(() => {
                    console.log('Game data saved successfully'); // è°ƒè¯•ä¿¡æ¯
                }).catch(error => {
                    console.error('Error saving game data:', error); // é”™è¯¯ä¿¡æ¯
                    alert('ä¿å­˜æ¸¸æˆæ•°æ®æ—¶å‡ºé”™ï¼š' + error.message);
                    return;
                });

                // å°†æ¸¸æˆIDæ·»åŠ åˆ°URL
                window.history.pushState({}, '', `?game=${gameId}`);
                
                totalAmount = parseFloat(amount);
                remainingAmount = totalAmount;
                gamePassword = password;
                maxParticipants = parseInt(participants);
                
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('winnersList').classList.remove('hidden');
                
                // æ˜¾ç¤ºåˆ†äº«éƒ¨åˆ†
                showShareSection();
                
                updateStatus();
                alert('æ¸¸æˆè®¾ç½®æˆåŠŸï¼');
                
                // å¼€å§‹ç›‘å¬æ¸¸æˆçŠ¶æ€
                initializeGameListeners(gameId);

            } catch (error) {
                console.error('Setup game error:', error); // é”™è¯¯ä¿¡æ¯
                alert('è®¾ç½®æ¸¸æˆæ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        function initializeGameListeners(gameId) {
            try {
                console.log('Initializing game listeners for ID:', gameId);
                const gameRef = dbRef(db, `games/${gameId}`);
                
                dbOnValue(gameRef, (snapshot) => {
                    const gameData = snapshot.val();
                    console.log('Game data received:', gameData);
                    
                    if (!gameData) {
                        console.log('No game data found');
                        return;
                    }

                    // æ›´æ–°ç•Œé¢çŠ¶æ€
                    totalAmount = gameData.totalAmount;
                    remainingAmount = gameData.remainingAmount;
                    gamePassword = gameData.gamePassword;
                    maxParticipants = gameData.maxParticipants;
                    participants = gameData.participants || [];
                    
                    // æ›´æ–°çŠ¶æ€å’Œä¸­å¥–åå•
                    updateStatus();
                    updateWinnersList(gameData.winners || []);
                    
                    // æ˜¾ç¤ºä¸­å¥–åå•å®¹å™¨
                    document.getElementById('winnersList').classList.remove('hidden');
                }, (error) => {
                    console.error('Error listening to game data:', error);
                    alert('ç›‘å¬æ¸¸æˆæ•°æ®æ—¶å‡ºé”™ï¼š' + error.message);
                });
            } catch (error) {
                console.error('Initialize listeners error:', error);
                alert('åˆå§‹åŒ–æ¸¸æˆç›‘å¬å™¨æ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        function checkPassword() {
            const inputPassword = document.getElementById('password').value;
            if (inputPassword === gamePassword) {
                document.getElementById('userPanel').classList.add('hidden');
                document.getElementById('lotteryPanel').classList.remove('hidden');
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function showLotteryAnimation(finalAmount) {
            // åˆ›å»ºåŠ¨ç”»å®¹å™¨
            const animationContainer = document.createElement('div');
            animationContainer.className = 'lottery-animation';
            
            const numberDisplay = document.createElement('div');
            numberDisplay.className = 'rolling-number shaking';
            
            const drumRoll = document.createElement('div');
            drumRoll.className = 'drum-roll';
            drumRoll.textContent = 'æŠ½å¥–ä¸­...';
            
            animationContainer.appendChild(numberDisplay);
            animationContainer.appendChild(drumRoll);
            document.body.appendChild(animationContainer);

            // æ’­æ”¾æ»šåŠ¨åŠ¨ç”»
            const steps = 30; // åŠ¨ç”»æ­¥æ•°
            const duration = 3000; // æ€»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            const stepDuration = duration / steps;
            
            for (let i = 0; i < steps; i++) {
                const randomAmount = Math.floor(Math.random() * (finalAmount * 2) / 5) * 5;
                numberDisplay.textContent = `RM ${randomAmount}`;
                await sleep(stepDuration);
            }

            // æœ€åæ˜¾ç¤ºå®é™…é‡‘é¢
            numberDisplay.classList.remove('shaking');
            numberDisplay.style.fontSize = '96px';
            numberDisplay.style.color = '#f1c40f';
            numberDisplay.textContent = `RM ${finalAmount}`;
            drumRoll.textContent = 'æ­å–œï¼';

            // ç­‰å¾…ä¸€ä¼šåç§»é™¤åŠ¨ç”»
            await sleep(1500);
            animationContainer.style.animation = 'fadeOut 0.3s ease';
            await sleep(300);
            document.body.removeChild(animationContainer);
        }

        async function drawLottery() {
            try {
                const gameId = new URLSearchParams(window.location.search).get('game');
                if (!gameId) {
                    alert('æ— æ•ˆçš„æ¸¸æˆIDï¼');
                    return;
                }

                const name = document.getElementById('userName').value;
                if (!name) {
                    alert('è¯·è¾“å…¥æ‚¨çš„åå­—ï¼');
                    return;
                }

                // è·å–æœ€æ–°æ¸¸æˆçŠ¶æ€
                const gameRef = dbRef(db, `games/${gameId}`);
                const snapshot = await dbGet(gameRef);
                const gameData = snapshot.val();

                if (!gameData) {
                    alert('æ¸¸æˆä¸å­˜åœ¨ï¼');
                    return;
                }

                if (gameData.participants && gameData.participants.includes(name)) {
                    alert('æ‚¨å·²ç»å‚ä¸è¿‡æŠ½å¥–äº†ï¼');
                    return;
                }

                if (gameData.participants && gameData.participants.length >= gameData.maxParticipants) {
                    alert('æŠ½å¥–äººæ•°å·²è¾¾ä¸Šé™ï¼');
                    return;
                }

                // è®¡ç®—æŠ½å¥–é‡‘é¢
                const remainingPeople = gameData.maxParticipants - (gameData.participants ? gameData.participants.length : 0) - 1;
                let amount = calculatePrizeAmount(gameData.remainingAmount, remainingPeople);

                // æ’­æ”¾åŠ¨ç”»
                await showLotteryAnimation(amount);

                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                const newParticipants = gameData.participants ? [...gameData.participants, name] : [name];
                const newWinners = gameData.winners ? [...gameData.winners] : [];
                newWinners.push({
                    name: name,
                    amount: amount,
                    timestamp: Date.now()
                });
                
                // æ›´æ–°Firebaseæ•°æ®
                await dbSet(gameRef, {
                    ...gameData,
                    remainingAmount: gameData.remainingAmount - amount,
                    participants: newParticipants,
                    winners: newWinners
                });

                // ç«‹å³æ›´æ–°æ˜¾ç¤º
                updateWinnersList(newWinners);
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('result').textContent = `æ­å–œè·å¾— RM ${amount}!`;
                
            } catch (error) {
                console.error('Draw lottery error:', error);
                alert('æŠ½å¥–è¿‡ç¨‹ä¸­å‡ºé”™ï¼š' + error.message);
            }
        }

        function updateWinnersList(winners) {
            const winnersContainer = document.getElementById('winnersContainer');
            const winnersList = document.getElementById('winnersList');
            
            // ç¡®ä¿ä¸­å¥–åå•å®¹å™¨å¯è§
            winnersList.classList.remove('hidden');
            winnersContainer.innerHTML = '';
            
            if (!winners || winners.length === 0) {
                winnersContainer.innerHTML = '<div class="winner-item">æš‚æ— ä¸­å¥–è®°å½•</div>';
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ä¸­å¥–è®°å½•
            winners.sort((a, b) => b.timestamp - a.timestamp).forEach(winner => {
                const winnerItem = document.createElement('div');
                winnerItem.className = 'winner-item';
                winnerItem.innerHTML = `
                    <span>${winner.name}</span>
                    <span>RM ${winner.amount}</span>
                `;
                winnersContainer.appendChild(winnerItem);
            });
        }

        function showShareSection() {
            const shareSection = document.getElementById('shareSection');
            const shareLinkDiv = document.getElementById('shareLink');
            const qrcodeDiv = document.getElementById('qrcode');
            
            // è·å–å½“å‰é¡µé¢URL
            const currentUrl = window.location.href;
            
            // æ˜¾ç¤ºé“¾æ¥
            shareLinkDiv.textContent = currentUrl;
            shareSection.classList.remove('hidden');
            
            // ç”ŸæˆäºŒç»´ç 
            qrcodeDiv.innerHTML = ''; // æ¸…é™¤ä¹‹å‰çš„äºŒç»´ç 
            new QRCode(qrcodeDiv, {
                text: currentUrl,
                width: 128,
                height: 128,
                colorDark : "#e74c3c",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function copyLink() {
            const shareLinkDiv = document.getElementById('shareLink');
            const text = shareLinkDiv.textContent;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(text).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
                copyBtn.style.background = '#e74c3c';
                
                setTimeout(() => {
                    copyBtn.textContent = 'å¤åˆ¶é“¾æ¥';
                    copyBtn.style.background = '#2ecc71';
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            });
        }

        function calculatePrizeAmount(remainingAmount, remainingPeople) {
            if (remainingPeople === 0) {
                return Math.floor(remainingAmount / 5) * 5; // æœ€åä¸€ä¸ªäººè·å¾—æ‰€æœ‰å‰©ä½™é‡‘é¢
            }

            // ç¡®ä¿æ¯ä¸ªäººè‡³å°‘èƒ½è·å¾—æœ€ä½é‡‘é¢
            const minAmount = 10;
            const maxAmount = remainingAmount - (remainingPeople * minAmount);
            
            if (maxAmount <= 0) {
                return minAmount; // å¦‚æœå‰©ä½™é‡‘é¢ä¸è¶³ï¼Œè¿”å›æœ€ä½é‡‘é¢
            }

            // ç”Ÿæˆéšæœºé‡‘é¢ï¼Œç¡®ä¿æ˜¯5çš„å€æ•°
            let randomAmount = Math.floor(Math.random() * maxAmount);
            randomAmount = Math.floor(randomAmount / 5) * 5;
            
            // ç¡®ä¿é‡‘é¢ä¸å°äºæœ€ä½é‡‘é¢
            return Math.max(randomAmount, minAmount);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLæ˜¯å¦åŒ…å«æ¸¸æˆID
        window.addEventListener('load', () => {
            console.log('Page loaded');
            const gameId = new URLSearchParams(window.location.search).get('game');
            console.log('Game ID from URL:', gameId);
            if (gameId) {
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('winnersList').classList.remove('hidden');
                initializeGameListeners(gameId);
            }
        });
    </script>
</body>
</html>
