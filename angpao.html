<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢åŒ…æŠ½å¥–</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        h2 {
            color: #e74c3c;
            margin-bottom: 25px;
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        input {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e74c3c;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        input:focus {
            border-color: #c0392b;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
        }

        button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 15px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.2);
        }

        button:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
        }

        .hidden {
            display: none;
        }

        .result {
            font-size: 28px;
            color: #e74c3c;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            background: rgba(231, 76, 60, 0.1);
            animation: fadeIn 0.5s ease;
        }

        .remaining {
            font-size: 16px;
            color: #7f8c8d;
            margin-top: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .red-packet {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23e74c3c" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>') no-repeat center;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* æ–°å¢åå•æ ·å¼ */
        .layout {
            display: flex;
            gap: 20px;
            max-width: 1000px;
            width: 95%;
            margin: 0 auto;
        }

        .winners-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .winner-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .layout {
                flex-direction: column;
            }
            .winners-list {
                width: auto;
                max-height: 300px;
            }
        }

        .status-info {
            background: rgba(231, 76, 60, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #e74c3c;
        }

        /* æ·»åŠ æŠ½å¥–åŠ¨ç”»ç›¸å…³æ ·å¼ */
        .lottery-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .rolling-number {
            font-size: 72px;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            margin-bottom: 20px;
            transition: transform 0.1s ease;
        }

        .drum-roll {
            font-size: 24px;
            color: #fff;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .shaking {
            animation: shake 0.1s ease-in-out infinite;
        }

        @keyframes shake {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(-1px, 1px) rotate(-1deg); }
            50% { transform: translate(1px, -1px) rotate(1deg); }
            75% { transform: translate(-1px, -1px) rotate(-1deg); }
            100% { transform: translate(1px, 1px) rotate(1deg); }
        }

        .share-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            text-align: center;
        }

        .share-section h3 {
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .share-link {
            word-break: break-all;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
        }

        .qr-code {
            margin: 15px auto;
        }

        .copy-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #27ae60;
        }

        .admin-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .admin-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .admin-btn:hover {
            background: #2980b9;
        }

        .status-info div {
            margin: 5px 0;
            font-size: 16px;
            color: #2c3e50;
        }

        .name-select {
            width: 80%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e74c3c;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
            background-color: white;
            cursor: pointer;
        }

        .name-select:focus {
            border-color: #c0392b;
            box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
        }

        .name-select option {
            padding: 10px;
            font-size: 16px;
        }
    </style>
    <!-- æ·»åŠ QRç ç”Ÿæˆåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <!-- åœ¨</head>å‰æ·»åŠ Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getDatabase, ref, set, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBO5zgKEHDE4hkVdWOVVpcpodB7Sl1UUro",
        authDomain: "angpao-da62f.firebaseapp.com",
        databaseURL: "https://angpao-da62f-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "angpao-da62f",
        storageBucket: "angpao-da62f.firebasestorage.app",
        messagingSenderId: "303412944902",
        appId: "1:303412944902:web:0e9c30451c4cc37258a387",
        measurementId: "G-WDX94CKZ1Q"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // å°†Firebaseå®ä¾‹æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸ
      window.db = db;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbPush = push;
      window.dbOnValue = onValue;
      window.dbGet = get;
      window.dbChild = child;

      // æ·»åŠ åˆå§‹åŒ–å®Œæˆçš„æ ‡å¿—
      window.firebaseInitialized = true;
      
      // è§¦å‘åˆå§‹åŒ–å®Œæˆäº‹ä»¶
      const event = new Event('firebaseInitialized');
      window.dispatchEvent(event);
    </script>
</head>
<body>
    <div class="layout">
        <div class="container">
            <div id="adminPanel">
                <h2>ğŸ§§ Red Packet Management</h2>
                <input type="text" id="setPassword" placeholder="Set Access Password">
                <button onclick="setupGame()">Confirm Settings</button>
            </div>

            <div id="userPanel" class="hidden">
                <div class="red-packet"></div>
                <h2>ğŸ‰ Red Packet Lucky Draw</h2>
                <div class="status-info" id="participantStatus"></div>
                <input type="text" id="password" placeholder="Please Enter Password">
                <button onclick="checkPassword()">Start Lucky Draw</button>
            </div>

            <div id="lotteryPanel" class="hidden">
                <div class="red-packet"></div>
                <h2>ğŸŠ Lucky Draw Panel</h2>
                <div class="status-info" id="lotteryStatus"></div>
                <select id="userName" class="name-select">
                    <option value="">Please Select Your Name</option>
                    <option value="Anna">Anna</option>
                    <option value="Khalila">Khalila</option>
                    <option value="BIBI">BIBI</option>
                    <option value="Aisyah">Aisyah</option>
                    <option value="Aisyah (M)">Aisyah (M)</option>
                    <option value="Nuha">Nuha</option>
                    <option value="Shafiqah">Shafiqah</option>
                    <option value="Aina">Aina</option>
                    <option value="Aliyyah">Aliyyah</option>
                    <option value="Mashita">Mashita</option>
                    <option value="Syalieza">Syalieza</option>
                </select>
                <button onclick="drawLottery()">Draw Now</button>
                <div id="result" class="result"></div>
            </div>

            <!-- æ·»åŠ åˆ†äº«éƒ¨åˆ† -->
            <div id="shareSection" class="share-section hidden">
                <h3>Share Link</h3>
                <div class="share-link" id="shareLink"></div>
                <button class="copy-btn" onclick="copyLink()">Copy Link</button>
                <div id="qrcode" class="qr-code"></div>
            </div>

            <!-- åœ¨container divä¸­æ·»åŠ æ–°çš„ç®¡ç†å‘˜æŸ¥çœ‹é¢æ¿ -->
            <div id="adminViewPanel" class="hidden">
                <h2>ğŸ® Admin Control Panel</h2>
                <div class="status-info">
                    <div>Total Amount: RM <span id="totalAmountDisplay">0</span></div>
                    <div>Remaining Amount: RM <span id="remainingAmountDisplay">0</span></div>
                    <div>Participants: <span id="participantCountDisplay">0</span> / <span id="maxParticipantsDisplay">0</span></div>
                </div>
                <div class="admin-controls">
                    <button onclick="closeGame()" class="admin-btn">End Game</button>
                    <button onclick="exportResults()" class="admin-btn">Export Results</button>
                </div>
            </div>
        </div>

        <div class="winners-list hidden" id="winnersList">
            <h2>ğŸ† Winners List</h2>
            <div id="winnersContainer"></div>
        </div>
    </div>

    <script>
        // ç­‰å¾… Firebase åˆå§‹åŒ–
        window.addEventListener('firebaseInitialized', () => {
            console.log('Firebase initialized, setting up page...');
            // æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰æ¸¸æˆ ID
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (gameId) {
                console.log('Found game ID in URL:', gameId);
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('winnersList').classList.remove('hidden');
                initializeGameListeners(gameId);
            }
        });

        let gamePassword = '';
        let totalAmount = 0;
        let remainingAmount = 0;
        let participants = [];
        let maxParticipants = 0;
        const MIN_AMOUNT = 10; // è®¾ç½®æœ€ä½é‡‘é¢ä¸º10

        function updateStatus() {
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (!gameId) return;

            const gameRef = window.dbRef(window.db, `games/${gameId}`);
            window.dbGet(gameRef).then(snapshot => {
                const gameData = snapshot.val();
                if (!gameData) return;

                const remainingSpots = gameData.maxParticipants - (gameData.participants ? gameData.participants.length : 0);
                const participantStatus = document.getElementById('participantStatus');
                const lotteryStatus = document.getElementById('lotteryStatus');
                const statusText = `Remaining Spots: ${remainingSpots} / Total: ${gameData.maxParticipants}`;
                
                if (participantStatus) {
                    participantStatus.innerHTML = statusText;
                }
                if (lotteryStatus) {
                    lotteryStatus.innerHTML = statusText;
                }
            });
        }

        async function setupGame() {
            if (!window.db || !window.dbRef || !window.dbSet || !window.dbPush) {
                console.error('Firebase functions not available');
                alert('Please wait for system initialization and try again.');
                return;
            }

            try {
                const password = document.getElementById('setPassword').value;

                if (!password) {
                    alert('Please set a password!');
                    return;
                }

                // åˆ›å»ºæ–°æ¸¸æˆ
                const gamesRef = window.dbRef(window.db, 'games');
                const newGameRef = window.dbPush(gamesRef);
                const gameId = newGameRef.key;

                const gameData = {
                    totalAmount: 220,          // å›ºå®šæ€»é‡‘é¢
                    remainingAmount: 220,      // åˆå§‹å‰©ä½™é‡‘é¢
                    gamePassword: password,
                    maxParticipants: 11,       // å›ºå®šå‚ä¸äººæ•°
                    participants: [],
                    winners: [],
                    createdAt: Date.now(),
                    isActive: true
                };

                await window.dbSet(newGameRef, gameData);

                // ä¿å­˜ç®¡ç†å‘˜å¯†ç 
                localStorage.setItem(`admin_${gameId}`, password);

                // æ›´æ–° URL
                window.history.pushState({}, '', `?game=${gameId}`);

                // æ›´æ–°ç•Œé¢
                document.getElementById('adminPanel').classList.add('hidden');
                document.getElementById('userPanel').classList.remove('hidden');
                document.getElementById('winnersList').classList.remove('hidden');
                document.getElementById('adminViewPanel').classList.remove('hidden');

                // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
                showShareSection();
                updateStatus();
                initializeGameListeners(gameId);
                updateAdminView(gameId);

                alert('Game setup successful!');

            } catch (error) {
                console.error('Setup game error:', error);
                alert('Error: ' + error.message);
            }
        }

        function initializeGameListeners(gameId) {
            try {
                console.log('Initializing game listeners for ID:', gameId);
                if (!gameId) {
                    console.error('No game ID provided');
                    return;
                }

                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                
                window.dbOnValue(gameRef, (snapshot) => {
                    const gameData = snapshot.val();
                    console.log('Game data received:', gameData);
                    
                    if (!gameData) {
                        console.log('No game data found');
                        return;
                    }

                    // æ›´æ–°å…¨å±€å˜é‡
                    window.totalAmount = gameData.totalAmount || 0;
                    window.remainingAmount = gameData.remainingAmount || 0;
                    window.gamePassword = gameData.gamePassword || '';
                    window.maxParticipants = gameData.maxParticipants || 0;
                    window.participants = gameData.participants || [];

                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    updateStatus();

                    // æ›´æ–°ä¸­å¥–åå•
                    updateWinnersList(gameData.winners || []);
                    
                    // æ˜¾ç¤ºä¸­å¥–åå•åŒºåŸŸ
                    document.getElementById('winnersList').classList.remove('hidden');

                    console.log('Game state updated:', {
                        maxParticipants: gameData.maxParticipants,
                        currentParticipants: gameData.participants ? gameData.participants.length : 0,
                        remainingSpots: gameData.maxParticipants - (gameData.participants ? gameData.participants.length : 0)
                    });
                });
            } catch (error) {
                console.error('Initialize listeners error:', error);
                alert('Error initializing game listeners: ' + error.message);
            }
        }

        async function checkPassword() {
            try {
                const gameId = new URLSearchParams(window.location.search).get('game');
                if (!gameId) {
                    alert('æ— æ•ˆçš„æ¸¸æˆIDï¼');
                    return;
                }

                const inputPassword = document.getElementById('password').value;
                if (!inputPassword) {
                    alert('è¯·è¾“å…¥å¯†ç ï¼');
                    return;
                }

                // è·å–æ¸¸æˆæ•°æ®
                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                const snapshot = await window.dbGet(gameRef);
                const gameData = snapshot.val();

                console.log('Game data:', gameData); // è°ƒè¯•ä¿¡æ¯

                if (!gameData) {
                    alert('æ¸¸æˆä¸å­˜åœ¨ï¼');
                    return;
                }

                if (gameData.isActive === false) {
                    alert('è¯¥æ¸¸æˆå·²ç»“æŸï¼');
                    return;
                }

                if (inputPassword === gameData.gamePassword) {
                    document.getElementById('userPanel').classList.add('hidden');
                    document.getElementById('lotteryPanel').classList.remove('hidden');
                    document.getElementById('winnersList').classList.remove('hidden');
                    updateStatus();
                } else {
                    alert('å¯†ç é”™è¯¯ï¼');
                }
            } catch (error) {
                console.error('Check password error:', error);
                alert('éªŒè¯å¯†ç æ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function showLotteryAnimation(finalAmount) {
            // åˆ›å»ºåŠ¨ç”»å®¹å™¨
            const animationContainer = document.createElement('div');
            animationContainer.className = 'lottery-animation';
            
            const numberDisplay = document.createElement('div');
            numberDisplay.className = 'rolling-number';
            
            const drumRoll = document.createElement('div');
            drumRoll.className = 'drum-roll';
            drumRoll.textContent = 'æŠ½å¥–ä¸­...';
            
            animationContainer.appendChild(numberDisplay);
            animationContainer.appendChild(drumRoll);
            document.body.appendChild(animationContainer);

            // ä¿®æ”¹éšæœºæ•°ç”Ÿæˆå‡½æ•°
            const getRandomAmount = () => {
                const amounts = [10, 15, 20, 25, 30, 35, 40, 45, 50]; // æœ€ä½ä»10å¼€å§‹
                return amounts[Math.floor(Math.random() * amounts.length)];
            };

            // åŠ¨ç”»å‚æ•°
            const totalDuration = 3000; // æ€»æŒç»­æ—¶é—´
            const startTime = Date.now();
            let lastUpdateTime = startTime;

            // åŠ¨ç”»å¾ªç¯
            return new Promise(resolve => {
                const animate = () => {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    
                    // æ ¹æ®æ—¶é—´æ¨ç§»è°ƒæ•´æ›´æ–°é¢‘ç‡å’Œæ˜¾ç¤ºæ•ˆæœ
                    if (currentTime - lastUpdateTime > (elapsed / totalDuration) * 100) {
                        // ç”Ÿæˆéšæœºæ•°
                        let displayAmount;
                        
                        if (elapsed < totalDuration * 0.7) {
                            // å‰70%æ—¶é—´ï¼Œå®Œå…¨éšæœº
                            displayAmount = getRandomAmount();
                        } else if (elapsed < totalDuration * 0.9) {
                            // 70%-90%æ—¶é—´ï¼Œåœ¨æœ€ç»ˆé‡‘é¢é™„è¿‘æ³¢åŠ¨
                            const variance = Math.max(5, Math.floor((totalDuration - elapsed) / 100));
                            displayAmount = finalAmount + (Math.random() - 0.5) * variance * 2;
                            displayAmount = Math.round(displayAmount / 5) * 5;
                        } else {
                            // æœ€å10%æ—¶é—´ï¼Œé€æ¸ç¨³å®šåˆ°æœ€ç»ˆé‡‘é¢
                            displayAmount = finalAmount;
                        }

                        // æ·»åŠ è§†è§‰æ•ˆæœ
                        const fontSize = Math.min(100, 60 + Math.random() * 40);
                        const hue = Math.floor(Math.random() * 360);
                        
                        numberDisplay.style.fontSize = `${fontSize}px`;
                        numberDisplay.style.color = `hsl(${hue}, 70%, 50%)`;
                        numberDisplay.style.transform = `scale(${1 + Math.random() * 0.2})`;
                        numberDisplay.textContent = `RM ${displayAmount}`;
                        
                        lastUpdateTime = currentTime;
                    }

                    if (elapsed < totalDuration) {
                        requestAnimationFrame(animate);
                    } else {
                        // åŠ¨ç”»ç»“æŸï¼Œæ˜¾ç¤ºæœ€ç»ˆé‡‘é¢
                        numberDisplay.style.fontSize = '96px';
                        numberDisplay.style.color = '#f1c40f';
                        numberDisplay.style.transform = 'scale(1.1)';
                        numberDisplay.textContent = `RM ${finalAmount}`;
                        drumRoll.textContent = 'æ­å–œï¼';
                        
                        // ç­‰å¾…ä¸€ä¼šåç§»é™¤åŠ¨ç”»
                        setTimeout(() => {
                            animationContainer.style.animation = 'fadeOut 0.3s ease';
                            setTimeout(() => {
                                document.body.removeChild(animationContainer);
                                resolve();
                            }, 300);
                        }, 1500);
                    }
                };

                requestAnimationFrame(animate);
            });
        }

        function calculatePrizeAmount(remainingAmount, remainingPeople, gameData) {
            // é¢„è®¾çš„ç‰¹å®šé‡‘é¢åˆ†ç»„
            const PRIZE_GROUPS = {
                '50': 1,  // 1ä¸ª50å…ƒå¥–
                '30': 2,  // 2ä¸ª30å…ƒå¥–
                '20': 3,  // 3ä¸ª20å…ƒå¥–
                '10': 5   // 5ä¸ª10å…ƒå¥–
            };
            
            // è·å–å·²ç»æŠ½ä¸­çš„é‡‘é¢åˆ—è¡¨
            const existingAmounts = (gameData.winners || []).map(w => w.amount);
            
            // ç»Ÿè®¡æ¯ä¸ªé‡‘é¢å·²è¢«æŠ½å–çš„æ¬¡æ•°
            const amountCounts = existingAmounts.reduce((acc, amount) => {
                acc[amount] = (acc[amount] || 0) + 1;
                return acc;
            }, {});
            
            // æ‰¾å‡ºè¿˜å¯ä»¥æŠ½å–çš„é‡‘é¢
            const availableAmounts = Object.entries(PRIZE_GROUPS)
                .filter(([amount, limit]) => {
                    const currentCount = amountCounts[amount] || 0;
                    return currentCount < limit;
                })
                .map(([amount]) => parseInt(amount));
            
            if (availableAmounts.length === 0) {
                console.error('No available amounts left!');
                return 0;
            }
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨é‡‘é¢
            const randomIndex = Math.floor(Math.random() * availableAmounts.length);
            return availableAmounts[randomIndex];
        }

        async function drawLottery() {
            try {
                const gameId = new URLSearchParams(window.location.search).get('game');
                if (!gameId) {
                    alert('æ— æ•ˆçš„æ¸¸æˆIDï¼');
                    return;
                }

                const name = document.getElementById('userName').value;
                if (!name) {
                    alert('è¯·é€‰æ‹©æ‚¨çš„åå­—ï¼');
                    return;
                }

                // è·å–æœ€æ–°æ¸¸æˆçŠ¶æ€
                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                const snapshot = await window.dbGet(gameRef);
                const gameData = snapshot.val();

                if (!gameData) {
                    alert('æ¸¸æˆä¸å­˜åœ¨ï¼');
                    return;
                }

                if (gameData.participants && gameData.participants.includes(name)) {
                    alert('æ‚¨å·²ç»å‚ä¸è¿‡æŠ½å¥–äº†ï¼');
                    return;
                }

                if (gameData.participants && gameData.participants.length >= gameData.maxParticipants) {
                    alert('æŠ½å¥–äººæ•°å·²è¾¾ä¸Šé™ï¼');
                    return;
                }

                // è®¡ç®—å‰©ä½™äººæ•°å’Œé‡‘é¢
                const remainingPeople = gameData.maxParticipants - (gameData.participants ? gameData.participants.length : 0) - 1;
                const remainingAmount = gameData.remainingAmount;

                console.log('æŠ½å¥–ä¿¡æ¯ï¼š', {
                    remainingAmount: remainingAmount,
                    remainingPeople: remainingPeople,
                    currentParticipants: gameData.participants ? gameData.participants.length : 0
                });

                let amount = calculatePrizeAmount(remainingAmount, remainingPeople, gameData);

                // æ’­æ”¾åŠ¨ç”»
                await showLotteryAnimation(amount);

                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                const newParticipants = gameData.participants ? [...gameData.participants, name] : [name];
                const newWinners = gameData.winners ? [...gameData.winners] : [];
                newWinners.push({
                    name: name,
                    amount: amount,
                    timestamp: Date.now()
                });
                
                await window.dbSet(gameRef, {
                    ...gameData,
                    remainingAmount: remainingAmount - amount,
                    participants: newParticipants,
                    winners: newWinners
                });

                // æ›´æ–°æ˜¾ç¤º
                updateWinnersList(newWinners);
                document.getElementById('result').textContent = `æ­å–œè·å¾— RM ${amount}!`;
                
            } catch (error) {
                console.error('Draw lottery error:', error);
                alert('æŠ½å¥–è¿‡ç¨‹ä¸­å‡ºé”™ï¼š' + error.message);
            }
        }

        function updateWinnersList(winners) {
            const winnersContainer = document.getElementById('winnersContainer');
            const winnersList = document.getElementById('winnersList');
            
            // ç¡®ä¿ä¸­å¥–åå•å®¹å™¨å¯è§
            winnersList.classList.remove('hidden');
            winnersContainer.innerHTML = '';
            
            if (!winners || winners.length === 0) {
                winnersContainer.innerHTML = '<div class="winner-item">æš‚æ— ä¸­å¥–è®°å½•</div>';
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ä¸­å¥–è®°å½•
            winners.sort((a, b) => b.timestamp - a.timestamp).forEach(winner => {
                const winnerItem = document.createElement('div');
                winnerItem.className = 'winner-item';
                winnerItem.innerHTML = `
                    <span>${winner.name}</span>
                    <span>RM ${winner.amount}</span>
                `;
                winnersContainer.appendChild(winnerItem);
            });
        }

        function showShareSection() {
            const shareSection = document.getElementById('shareSection');
            const shareLinkDiv = document.getElementById('shareLink');
            const qrcodeDiv = document.getElementById('qrcode');
            
            // è·å–å½“å‰é¡µé¢URL
            const currentUrl = window.location.href;
            
            // æ˜¾ç¤ºé“¾æ¥
            shareLinkDiv.textContent = currentUrl;
            shareSection.classList.remove('hidden');
            
            // ç”ŸæˆäºŒç»´ç 
            qrcodeDiv.innerHTML = ''; // æ¸…é™¤ä¹‹å‰çš„äºŒç»´ç 
            new QRCode(qrcodeDiv, {
                text: currentUrl,
                width: 128,
                height: 128,
                colorDark : "#e74c3c",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        function copyLink() {
            const shareLinkDiv = document.getElementById('shareLink');
            const text = shareLinkDiv.textContent;
            
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(text).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                copyBtn.textContent = 'å·²å¤åˆ¶ï¼';
                copyBtn.style.background = '#e74c3c';
                
                setTimeout(() => {
                    copyBtn.textContent = 'å¤åˆ¶é“¾æ¥';
                    copyBtn.style.background = '#2ecc71';
                }, 2000);
            }).catch(err => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
            });
        }

        // æ·»åŠ ç®¡ç†å‘˜è§†å›¾æ›´æ–°å‡½æ•°
        function updateAdminView(gameId) {
            const gameRef = window.dbRef(window.db, `games/${gameId}`);
            
            window.dbOnValue(gameRef, (snapshot) => {
                const gameData = snapshot.val();
                if (!gameData) return;

                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('totalAmountDisplay').textContent = gameData.totalAmount;
                document.getElementById('remainingAmountDisplay').textContent = gameData.remainingAmount;
                document.getElementById('participantCountDisplay').textContent = 
                    gameData.participants ? gameData.participants.length : 0;
                document.getElementById('maxParticipantsDisplay').textContent = gameData.maxParticipants;
            });
        }

        // æ·»åŠ ç»“æŸæ¸¸æˆåŠŸèƒ½
        async function closeGame() {
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (!gameId) return;

            const adminPassword = localStorage.getItem(`admin_${gameId}`);
            const inputPassword = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç»“æŸæ¸¸æˆï¼š');
            
            if (inputPassword !== adminPassword) {
                alert('å¯†ç é”™è¯¯ï¼');
                return;
            }

            try {
                const gameRef = window.dbRef(window.db, `games/${gameId}`);
                await window.dbSet(gameRef, {
                    isActive: false
                }, { merge: true });
                alert('æ¸¸æˆå·²ç»“æŸï¼');
            } catch (error) {
                console.error('Close game error:', error);
                alert('ç»“æŸæ¸¸æˆæ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        // æ·»åŠ å¯¼å‡ºç»“æœåŠŸèƒ½
        function exportResults() {
            const gameId = new URLSearchParams(window.location.search).get('game');
            if (!gameId) return;

            const adminPassword = localStorage.getItem(`admin_${gameId}`);
            const inputPassword = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥å¯¼å‡ºç»“æœï¼š');
            
            if (inputPassword !== adminPassword) {
                alert('å¯†ç é”™è¯¯ï¼');
                return;
            }

            const gameRef = window.dbRef(window.db, `games/${gameId}`);
            window.dbGet(gameRef).then((snapshot) => {
                const gameData = snapshot.val();
                if (!gameData) return;

                const winners = gameData.winners || [];
                let csv = 'åå­—,é‡‘é¢,æ—¶é—´\n';
                
                winners.forEach(winner => {
                    const date = new Date(winner.timestamp).toLocaleString();
                    csv += `${winner.name},${winner.amount},${date}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æŠ½å¥–ç»“æœ_${new Date().toLocaleDateString()}.csv`;
                a.click();
            });
        }
    </script>
</body>
</html>
