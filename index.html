<!DOCTYPE html>
<html lang="zh">

<head>
    <!-- æ‚¨ç°æœ‰çš„ head å†…å®¹ä¿æŒä¸å˜ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Tools</title>
    <style>
        /* æ‚¨ç°æœ‰çš„ CSS æ ·å¼ä¿æŒä¸å˜ */
        body {
            font-family: Arial, sans-serif;
            padding: 15px;
            margin: 0;
            background-color: #1c1c1c;
            color: #e0e0e0;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background-color: #1c1c1c;
            color: #e0e0e0;
        }

        .category-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        #suggestions {
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            position: absolute;
            width: 170px;
            z-index: 10;
        }

        .contact-info {
            font-size: 1rem;
            /* å­—ä½“å¤§å° */
            font-style: italic;
            /* æ–œä½“ */
            color: #555;
            /* æµ…ç°è‰²å­—ä½“ */
            text-align: center;
            /* å±…ä¸­å¯¹é½ */
            background-color: #f9f9f9;
            /* æŸ”å’Œçš„èƒŒæ™¯è‰² */
            padding: 10px;
            /* å†…è¾¹è· */
            border-radius: 8px;
            /* åœ†è§’è¾¹æ¡† */
            margin-bottom: 20px;
            /* ä¸ä¸‹æ–¹å†…å®¹çš„é—´è· */
            border: 1px solid #ddd;
            /* æµ…è‰²è¾¹æ¡† */
        }

        #suggestions div {
            padding: 8px;
            cursor: pointer;
            color: #333;
        }

        #suggestions div:hover {
            background-color: #f0f0f0;
        }

        #productList div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #productList label {
            flex-grow: 1;
            margin-right: 10px;
        }

        input[type="number"] {
            width: 80px;
            margin-left: 10px;
            text-align: right;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 110px;
        }

        #result {
            width: 100%;
            height: 250px;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            overflow: auto;
            font-size: 1.1rem;
            color: black;
            background-color: #fff;
            border-radius: 8px;
        }

        .button-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        button {
            padding: 5px 10px;
            font-size: 1rem;
            margin: 0 5px;
            cursor: pointer;
        }

        span {
            font-size: 1.2rem;
        }

        .toggle-mode-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            margin-bottom: 20px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
        }

        .saved-button {
            background-color: #007bff;
        }

        #searchBar {
            width: 150px;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1.1rem;
        }

        .payment-section {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #2c2c2c;
        }

        .payment-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .payment-option {
            padding: 15px 10px;
            border-radius: 8px;
            background-color: #3c3c3c;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        .payment-option span {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .payment-option span i {
            font-size: 1.5rem;
        }

        .payment-option:hover {
            background-color: #4c4c4c;
            transform: translateY(-2px);
        }

        .payment-option.selected {
            background-color: #007bff;
            color: white;
        }

        /* æ·»åŠ å“åº”å¼è®¾è®¡ */
        @media screen and (max-width: 600px) {
            .payment-options {
                grid-template-columns: repeat(3, 1fr);
            }

            .payment-option {
                padding: 10px 5px;
                min-height: 50px;
            }

            .payment-option span {
                font-size: 0.8rem;
            }

            /* é’ˆå¯¹å°å±å¹•ä¼˜åŒ–æ¨¡æ€æ¡† */
            #modalContainer {
                width: 90%;
                /* å æ»¡å¤§éƒ¨åˆ†å±å¹• */
                max-height: 70%;
                /* é«˜åº¦ä¸è¶…è¿‡å±å¹•çš„ 70% */
            }

            #modalContainer button {
                font-size: 1rem;
                /* è°ƒæ•´æŒ‰é’®å­—ä½“å¤§å° */
                padding: 10px;
                /* å¢åŠ æŒ‰é’®çš„ç‚¹å‡»åŒºåŸŸ */
            }
        }

        /* æ¨¡æ€æ¡†å…¬å…±æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal button {
            margin-top: 20px;
            background-color: red;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: block;
            width: 100%;
        }

        .close-button {
            background-color: #007bff;
        }

    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>

<body>

    <div class="header">
        <h1>Sales Listing</h1>
    </div>

    <div class="search-container" style="position: relative;">
        <input type="text" id="searchBar" placeholder="Search for items..." onfocus="this.value=''"
            onkeyup="searchItems()">
        <div id="suggestions"></div>
    </div>

    <h3>Category</h3>
    <div class="category-container" id="categoryContainer"></div>

    <div id="productList"></div>

    <div class="payment-section" style="display: none;">
        <h3>Payment Method</h3>
        <div class="payment-options">
            <label class="payment-option">
                <input type="radio" name="store" value="Cash" onclick="toggleCashInput(); updateResult(); selectPayment(this)">
                <span>
                    ğŸ’µ<br>
                    Cash
                </span>
            </label>
            <label class="payment-option">
                <input type="radio" name="store" value="Card" onclick="hideCashInput(); updateResult(); selectPayment(this)">
                <span>
                    ğŸ’³<br>
                    Card
                </span>
            </label>
            <label class="payment-option">
                <input type="radio" name="store" value="E-Wallet" onclick="hideCashInput(); updateResult(); selectPayment(this)">
                <span>
                    ğŸ“±<br>
                    E-wallet
                </span>
            </label>
        </div>
    </div>

    <div id="cashInputContainer" style="display: none;">
        <input type="number" id="cashAmount" placeholder="Enter cash amount"
            style="background-color: white; color: black; padding: 5px;"
            oninput="calculateChange()">
        <div id="changeAmount" style="color: #e0e0e0; margin-left: 10px; display: inline-block;"></div>
    </div>

    <div class="action-buttons">
        <button onclick="clearAll()">Next Customer</button>
        <span id="currentBillDisplay" style="margin-left: 10px; font-weight: bold;">Current Bill: 001</span>
    </div>

    <div id="result"></div>

    <div>
        <h3>Search or Delete Bill</h3>
        <input type="text" id="billSearchInput" placeholder="Enter bill number (e.g., 001)">
        <button onclick="searchBill(document.getElementById('billSearchInput').value)">Search</button>
        <button onclick="deleteBill()">Delete</button>
    </div>

    <div>
        <button onclick="showSalesClosing()" style="margin-top: 20px; padding: 10px 20px; font-size: 16px;">Sales Closing</button>
    </div>

<script>
    // Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyCsK-jF0s5losIGNrlxmD83UCzAsXi7gaQ",
        authDomain: "sales-listing-8d2d7.firebaseapp.com",
        databaseURL: "https://sales-listing-8d2d7-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "sales-listing-8d2d7",
        storageBucket: "sales-listing-8d2d7.firebasestorage.app",
        messagingSenderId: "893973257981",
        appId: "1:893973257981:web:40cfb9612babe692e76894",
        measurementId: "G-JQ8RWV1S7C"
    };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    let categories = {}; // å­˜å‚¨ä» Firebase è·å–çš„åˆ†ç±»å’Œå•†å“
    let selectedItems = {};
    let billNumber = 1; // å•æ®ç¼–å·
    let selectedStore = ""; // ä¿å­˜é€‰ä¸­çš„åº—é“ºåç§°
    let supervisorName = "";
    let cashierName = "";

    window.onload = function () {
        // å¼€å§‹æ—¶æ˜¾ç¤ºè¾“å…¥ Supervisor å’Œ Cashier çš„å¼¹çª—
        showSupervisorAndCashierModal();

        // è®¾ç½®å®æ—¶ç›‘å¬ï¼ŒåŠ è½½ç±»åˆ«å’Œå•†å“æ•°æ®
        setupRealtimeListeners();
    };

    function setupRealtimeListeners() {
        database.ref('products').on('value', (snapshot) => {
            categories = snapshot.val();
            console.log("Categories updated:", categories); // è°ƒè¯•æ—¥å¿—
            const categoryContainer = document.getElementById("categoryContainer");
            categoryContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰åˆ†ç±»æŒ‰é’®

            // å°†ç±»åˆ«è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰ 'order' æ’åº
            const categoriesArray = Object.keys(categories).map(categoryKey => {
                return { key: categoryKey, order: categories[categoryKey].order || 0 };
            }).sort((a, b) => a.order - b.order);

            // åŠ¨æ€ç”Ÿæˆæ’åºåçš„ç±»åˆ«æŒ‰é’®
            categoriesArray.forEach(category => {
                const label = document.createElement("label");
                label.innerHTML = `<input type="radio" name="category" value="${category.key}" onclick="showCategory()">${category.key}`;
                categoryContainer.appendChild(label);
            });

            // å¦‚æœæœ‰å·²é€‰æ‹©çš„ç±»åˆ«ï¼Œé‡æ–°åŠ è½½è¯¥ç±»åˆ«çš„å•†å“
            let selectedCategory = document.querySelector('input[name="category"]:checked');
            if (selectedCategory) {
                showCategory();
            }
        }, (error) => {
            console.error("Error listening to products: ", error);
        });
    }

    function showSupervisorAndCashierModal() {
        const modal = document.getElementById("supervisorModal");
        modal.style.display = "block"; // æ˜¾ç¤ºæ¨¡æ€æ¡†
    }

    function submitSupervisorAndCashier() {
        const supervisorInput = document.getElementById("supervisorInput").value.trim();
        const cashierInput = document.getElementById("cashierInput").value.trim();

        if (!supervisorInput || !cashierInput) {
            alert("Both Supervisor and Cashier names are required!");
            return;
        }

        supervisorName = supervisorInput;
        cashierName = cashierInput;

        // éšè—æ¨¡æ€æ¡†
        const modal = document.getElementById("supervisorModal");
        modal.style.display = "none";

        // æ˜¾ç¤ºåº—é“ºé€‰æ‹©æ¨¡æ€æ¡†
        showStoreSelectionModal();
    }

    function showStoreSelectionModal() {
        const modal = document.getElementById("storeModal");
        modal.style.display = "block"; // æ˜¾ç¤ºæ¨¡æ€æ¡†
    }

    function selectStore(storeName) {
        selectedStore = storeName;

        // éšè—æ¨¡æ€æ¡†
        const modal = document.getElementById("storeModal");
        modal.style.display = "none";

        alert(`Store "${storeName}" selected successfully.`);
        resetAllData(); // é‡ç½®æ•°æ®
        updateCurrentBillDisplay();
    }

    function resetAllData() {
        billNumber = 1;
        selectedItems = {};

        // Reset the display
        alert(`All previous data has been reset. Starting fresh from Bill 001.`);
    }

    function loadProducts(productsObj) {
        const productList = document.getElementById('productList');
        productList.innerHTML = '';

        // å°† productsObj è½¬æ¢ä¸ºæ•°ç»„ï¼Œå¹¶æŒ‰ 'order' æ’åºï¼Œè·³è¿‡ 'order' å­—æ®µ
        const productsArray = Object.keys(productsObj)
            .filter(productId => productId !== "order") // è·³è¿‡ 'order' å­—æ®µ
            .map(productId => {
                return { id: productId, ...productsObj[productId] };
            })
            .sort((a, b) => (a.order || 0) - (b.order || 0));

        productsArray.forEach(product => {
            const div = document.createElement('div');

            if (product.customPrice) {
                div.innerHTML = `
                    <label>${product.name}</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" 
                               id="price${product.id}" 
                               placeholder="Enter price" 
                               style="width: 100px; padding: 5px; background-color: white; color: black;"
                               step="0.10">
                        <button onclick="addCustomItem('${product.id}', '${product.name}')">Add</button>
                        <span onclick="removeItem('${product.id}-custom')" style="cursor: pointer;">âŒ</span>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <input type="checkbox" id="item${product.id}" onchange="saveItem('${product.id}', '${product.name}', ${product.price})">
                    <label for="item${product.id}">${product.name} - RM${product.price.toFixed(2)}</label>
                    <div style="display: flex; align-items: center;">
                        <button onclick="decreaseQuantity('${product.id}')">-</button>
                        <span id="quantityDisplay${product.id}" style="padding: 0 10px;">1</span>
                        <button onclick="increaseQuantity('${product.id}')">+</button>
                        <span onclick="removeItem('${product.id}')" style="cursor: pointer;">âŒ</span>
                    </div>
                `;
            }

            productList.appendChild(div);
        });
    }

    function removeItem(uniqueId) {
        const checkbox = document.getElementById('item' + uniqueId);
        if (checkbox) {
            checkbox.checked = false;
            checkbox.onchange(); // è§¦å‘ä¿å­˜æ“ä½œï¼Œç§»é™¤å•†å“
        } else {
            // å¦‚æœæ˜¯è‡ªå®šä¹‰å•†å“ï¼Œç›´æ¥ä» selectedItems ä¸­åˆ é™¤
            delete selectedItems[uniqueId];
        }
        updateResult();
    }

    function increaseQuantity(id) {
        const quantityDisplay = document.getElementById(`quantityDisplay${id}`);
        let currentQuantity = parseInt(quantityDisplay.textContent);
        currentQuantity++;
        quantityDisplay.textContent = currentQuantity;
        saveQuantity(id, currentQuantity);  // æ›´æ–°é€‰ä¸­çš„å•†å“æ•°é‡
        updateResult();
    }

    function decreaseQuantity(id) {
        const quantityDisplay = document.getElementById(`quantityDisplay${id}`);
        let currentQuantity = parseInt(quantityDisplay.textContent);
        if (currentQuantity > 1) {  // ç¡®ä¿æ•°é‡ä¸å°äº 1
            currentQuantity--;
            quantityDisplay.textContent = currentQuantity;
            saveQuantity(id, currentQuantity);  // æ›´æ–°é€‰ä¸­çš„å•†å“æ•°é‡
            updateResult();
        }
    }

    function searchItems() {
        const searchTerm = document.getElementById('searchBar').value.toLowerCase();
        const allProducts = [];

        // éå†æ¯ä¸ªç±»åˆ«ï¼Œæ”¶é›†æ‰€æœ‰å•†å“ï¼Œè·³è¿‡ 'order' å­—æ®µ
        for (let category in categories) {
            for (let productId in categories[category]) {
                if (productId === "order") continue; // è·³è¿‡ 'order' å­—æ®µ
                const product = categories[category][productId];
                allProducts.push({ id: productId, ...product });
            }
        }

        console.log("All products:", allProducts); // è°ƒè¯•æ—¥å¿—

        const filteredProducts = allProducts.filter(product => product.name.toLowerCase().includes(searchTerm));

        console.log("Filtered products:", filteredProducts); // è°ƒè¯•æ—¥å¿—

        // æ¸…ç©ºå»ºè®®åˆ—è¡¨
        const suggestionsDiv = document.getElementById('suggestions');
        suggestionsDiv.innerHTML = '';

        // å¦‚æœæœç´¢æ ä¸ºç©ºï¼Œä¸æ˜¾ç¤ºå»ºè®®
        if (searchTerm === '') {
            return;
        }

        // æ˜¾ç¤ºå»ºè®®åˆ—è¡¨
        filteredProducts.forEach(product => {
            const suggestionItem = document.createElement('div');
            suggestionItem.textContent = product.name;
            suggestionItem.onclick = function () {
                document.getElementById('searchBar').value = product.name;
                suggestionsDiv.innerHTML = '';  // æ¸…ç©ºå»ºè®®åˆ—è¡¨
                // ä¼ é€’ä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸ºå•†å“IDï¼Œå€¼ä¸ºå•†å“ä¿¡æ¯
                const singleProduct = {};
                singleProduct[product.id] = product;
                loadProducts(singleProduct);
            };
            suggestionsDiv.appendChild(suggestionItem);
        });
    }

    function saveItem(id, name, price) {
        const checkbox = document.getElementById("item" + id);
        const quantity = parseInt(document.getElementById("quantityDisplay" + id).textContent) || 1;

        if (checkbox.checked) {
            selectedItems[id] = { name: name, quantity: quantity, price: price };
        } else {
            delete selectedItems[id];
        }

        // å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªå•†å“è¢«é€‰æ‹©ï¼Œæ˜¾ç¤ºæ”¯ä»˜æ–¹å¼
        if (Object.keys(selectedItems).length > 0) {
            togglePaymentMethod(true);
        } else {
            togglePaymentMethod(false);
        }

        updateResult();
    }

    function saveQuantity(id, quantity) {
        if (selectedItems[id]) {
            selectedItems[id].quantity = quantity;
        }
    }

    function toggleItems() {
        let checkboxes = document.querySelectorAll('#productList input[type="checkbox"]');
        let quantities = document.querySelectorAll('#productList input[type="number"]');

        checkboxes.forEach((checkbox) => (checkbox.disabled = false));
        quantities.forEach((quantity) => (quantity.disabled = false));
    }

    function showCategory() {
        let selectedCategory = document.querySelector('input[name="category"]:checked');

        if (selectedCategory) {
            let categoryValue = selectedCategory.value;
            let productsToShow = categories[categoryValue];

            if (productsToShow) {
                loadProducts(productsToShow);
            } else {
                console.error("æ²¡æœ‰æ‰¾åˆ°è¯¥åˆ†ç±»çš„å•†å“");
            }
        } else {
            console.error("æ²¡æœ‰é€‰ä¸­ä»»ä½•åˆ†ç±»");
        }

        toggleItems();
    }

    function calculateTotal() {
        let total = 0;
        for (const item of Object.values(selectedItems)) {
            total += item.quantity * item.price;
        }
        return total.toFixed(2);
    }

    function updateResult() {
        let result = `Store: ${selectedStore}\n`;
        result += `Supervisor: ${supervisorName}\n`;
        result += `Cashier: ${cashierName}\n\n`;

        const formattedBillNumber = billNumber.toString().padStart(3, "0");
        result += `Bill No: ${formattedBillNumber}\n`;

        let selectedPaymentMethod = document.querySelector('input[name="store"]:checked');
        if (selectedPaymentMethod) {
            result += "Payment: " + selectedPaymentMethod.value + "\n\n";
        } else {
            result += "Payment: No Select\n";
        }

        for (const itemId in selectedItems) {
            const item = selectedItems[itemId];
            result += `${item.name} - ${item.quantity} pc, RM${(item.quantity * item.price).toFixed(2)}\n`;
        }

        result += `\nTotal: RM${calculateTotal()}\n`;

        const currentDate = new Date();
        const dateString = currentDate.toLocaleDateString();
        const timeString = currentDate.toLocaleTimeString();
        result += `\nDate: ${dateString}\nTime: ${timeString}`;

        document.getElementById("result").innerText = result;
    }

    function clearAll() {
        // æ£€æŸ¥æ˜¯å¦æœ‰å•†å“
        if (Object.keys(selectedItems).length === 0) {
            alert("Please add at least one product before proceeding to the next bill.");
            return;
        }

        // æ£€æŸ¥æ”¯ä»˜æ–¹å¼
        const selectedPaymentMethod = document.querySelector('input[name="store"]:checked');
        if (!selectedPaymentMethod) {
            alert("Please select a payment method before proceeding.");
            return;
        }

        const total = parseFloat(calculateTotal());

        // å¦‚æœé€‰æ‹©äº† Cashï¼Œéœ€è¦ç¡®ä¿è¾“å…¥äº†ç°é‡‘é‡‘é¢
        if (selectedPaymentMethod.value === "Cash") {
            const cashAmount = parseFloat(document.getElementById("cashAmount").value);

            if (isNaN(cashAmount) || cashAmount < total) {
                alert("Please enter a valid cash amount that is equal to or greater than the total amount.");
                return;
            }

            // Update change
            const change = cashAmount - total;
            if (change >= 0) {
                document.getElementById("changeAmount").textContent = `Change: RM${change.toFixed(2)}`;
            } else {
                document.getElementById("changeAmount").textContent = `Insufficient amount`;
                return;
            }
        }

        // Save the bill
        saveBill();
    }

    function toggleDarkMode() {
        const isDarkModeEnabled = document.body.classList.toggle('dark-mode');
        const toggleButton = document.querySelector('.toggle-mode-btn');

        if (isDarkModeEnabled) {
            toggleButton.textContent = 'åˆ‡æ¢è‡³æ­£å¸¸æ¨¡å¼';
            localStorage.setItem('dark-mode', 'enabled');
        } else {
            toggleButton.textContent = 'åˆ‡æ¢è‡³é»‘æš—æ¨¡å¼';
            localStorage.setItem('dark-mode', 'disabled');
        }
    }

    function toggleCashInput() {
        document.getElementById("cashInputContainer").style.display = "block";
        calculateChange();
    }

    function hideCashInput() {
        document.getElementById("cashInputContainer").style.display = "none";
        document.getElementById("changeAmount").textContent = "";
    }

    function calculateChange() {
        const cashAmount = parseFloat(document.getElementById("cashAmount").value) || 0;
        const total = parseFloat(calculateTotal());
        const change = cashAmount - total;

        if (!isNaN(change) && change >= 0) {
            document.getElementById("changeAmount").textContent = `Change: RM${change.toFixed(2)}`;
        } else if (!isNaN(change) && change < 0) {
            document.getElementById("changeAmount").textContent = `Insufficient amount`;
        } else {
            document.getElementById("changeAmount").textContent = "";
        }

        updateResult();
    }

    function selectPayment(radio) {
        // ç§»é™¤æ‰€æœ‰æ”¯ä»˜é€‰é¡¹çš„é€‰ä¸­æ ·å¼
        document.querySelectorAll(".payment-option").forEach((option) => {
            option.classList.remove("selected");
        });

        // ä¸ºé€‰ä¸­çš„æ”¯ä»˜é€‰é¡¹æ·»åŠ æ ·å¼
        if (radio.checked) {
            radio.closest(".payment-option").classList.add("selected");
        }
    }

    function addCustomItem(id, name) {
        const priceInput = document.getElementById('price' + id);
        const price = parseFloat(priceInput.value);

        if (isNaN(price) || price <= 0) {
            alert('Please enter a valid price');
            return;
        }

        // ç”Ÿæˆå”¯ä¸€çš„ IDï¼Œé¿å…é‡å¤
        const uniqueId = `${id}-custom-${Date.now()}`;

        // æ·»åŠ åˆ° selectedItemsï¼Œç¡®ä¿æ¯æ¬¡éƒ½æ˜¯æ–°è®°å½•
        selectedItems[uniqueId] = { name: name, quantity: 1, price: price };

        updateResult();

        // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        const successMessage = document.createElement('div');
        successMessage.textContent = `${name} added successfully!`;
        successMessage.style.color = 'green';
        successMessage.style.position = 'fixed';
        successMessage.style.top = '20px';
        successMessage.style.right = '20px';
        successMessage.style.backgroundColor = '#d4edda';
        successMessage.style.padding = '10px';
        successMessage.style.borderRadius = '5px';
        successMessage.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
        document.body.appendChild(successMessage);
        setTimeout(() => successMessage.remove(), 3000); // 3ç§’åè‡ªåŠ¨ç§»é™¤æç¤ºä¿¡æ¯

        // æ¸…ç©ºä»·æ ¼è¾“å…¥æ¡†
        priceInput.value = '';
    }

    function saveBill() {
        if (!selectedStore) {
            alert("Please select a store before saving the bill.");
            return;
        }

        const formattedBillNumber = billNumber.toString().padStart(3, "0"); // æ ¼å¼åŒ–ä¸ºä¸‰ä½æ•°ï¼Œå¦‚ 001, 002

        // åˆ›å»ºå•æ®å¯¹è±¡
        const billData = {
            billNumber: formattedBillNumber,
            store: selectedStore,
            supervisor: supervisorName,
            cashier: cashierName,
            paymentMethod: document.querySelector('input[name="store"]:checked') ? document.querySelector('input[name="store"]:checked').value : "No Select",
            items: selectedItems,
            total: parseFloat(calculateTotal()),
            date: new Date().toISOString()
        };

        // å°†å•æ®å­˜å‚¨åˆ° Realtime Database çš„ "stores/{store}/bills/{billNumber}" èŠ‚ç‚¹ä¸­
        database.ref(`stores/${selectedStore}/bills/${formattedBillNumber}`).set(billData, function (error) {
            if (error) {
                console.error("Error saving bill: ", error);
                alert("ä¿å­˜å•æ®æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚");
            } else {
                // æ›´æ–°é”€å”®ç»Ÿè®¡æ•°æ®
                updateSalesSummary(selectedStore, billData);

                // æ›´æ–°å•æ®ç¼–å·
                billNumber++;
                updateCurrentBillDisplay();

                alert(`Bill ${formattedBillNumber} saved successfully!`);

                // Clear selections for next customer
                selectedItems = {};
                document.getElementById("productList").innerHTML = "";
                document.getElementById("result").innerText = "";
                document.querySelectorAll('input[name="store"]').forEach((input) => (input.checked = false));
                document.querySelectorAll('input[name="category"]').forEach((input) => (input.checked = false));
                togglePaymentMethod(false); // éšè—æ”¯ä»˜æ–¹å¼
                hideCashInput(); // éšè—ç°é‡‘è¾“å…¥æ¡†
                toggleItems();
            }
        });
    }

    function updateSalesSummary(store, billData) {
        const paymentMethod = billData.paymentMethod; // "Cash", "Card", "E-Wallet"
        const total = billData.total;

        // Update salesSummary for the specific store
        const salesSummaryRef = database.ref(`stores/${store}/salesSummary`);
        salesSummaryRef.once('value', function (snapshot) {
            let currentData = snapshot.val();
            if (!currentData) {
                currentData = { cash: 0, card: 0, ewallet: 0 };
            }

            if (paymentMethod === "Cash") {
                currentData.cash += total;
            } else if (paymentMethod === "Card") {
                currentData.card += total;
            } else if (paymentMethod === "E-Wallet") {
                currentData.ewallet += total;
            }

            // Save updated salesSummary back to database
            salesSummaryRef.set(currentData, function (error) {
                if (error) {
                    console.error("Error updating sales summary: ", error);
                } else {
                    console.log("Sales summary updated successfully.");
                }
            });
        }, function (error) {
            console.error("Error fetching sales summary: ", error);
        });

        // Update soldItems for the specific store
        const soldItemsRef = database.ref(`stores/${store}/soldItems`);
        for (const itemId in billData.items) {
            const item = billData.items[itemId];
            const itemNameKey = item.name.replace(/\s+/g, '_'); // ç”¨ä¸‹åˆ’çº¿æ›¿ä»£ç©ºæ ¼

            soldItemsRef.child(itemNameKey).once('value', function (snapshot) {
                let currentItemData = snapshot.val();
                if (!currentItemData) {
                    currentItemData = { quantity: 0, totalPrice: 0 };
                }

                currentItemData.quantity += item.quantity;
                currentItemData.totalPrice += item.quantity * item.price;

                // Save updated item data back to database
                soldItemsRef.child(itemNameKey).set(currentItemData, function (error) {
                    if (error) {
                        console.error(`Error updating sold item ${item.name}: `, error);
                    } else {
                        console.log(`Sold item ${item.name} updated successfully.`);
                    }
                });
            }, function (error) {
                console.error(`Error fetching sold item ${item.name}: `, error);
            });
        }
    }

    function updateCurrentBillDisplay() {
        const formattedBillNumber = billNumber.toString().padStart(3, "0");
        document.getElementById("currentBillDisplay").textContent = `Current Bill: ${formattedBillNumber}`;
    }

    function searchBill(billInput) {
        const billKey = billInput.padStart(3, "0"); // ç¡®ä¿æ˜¯ä¸‰ä½æ•°

        if (!selectedStore) {
            alert("Please select a store before searching for bills.");
            return;
        }

        database.ref(`stores/${selectedStore}/bills/${billKey}`).once('value', function (snapshot) {
            if (snapshot.exists()) {
                const billData = snapshot.val();
                const billText = `
Store: ${billData.store}
Supervisor: ${billData.supervisor}
Cashier: ${billData.cashier}

Bill No: ${billData.billNumber}
Payment: ${billData.paymentMethod}

${Object.values(billData.items).map(item => `${item.name} - ${item.quantity} pc, RM${(item.quantity * item.price).toFixed(2)}`).join('\n')}

Total: RM${billData.total.toFixed(2)}

Date: ${new Date(billData.date).toLocaleDateString()}
Time: ${new Date(billData.date).toLocaleTimeString()}
                `;
                showModal(billText, billKey);
            } else {
                alert(`Bill ${billInput} not found.`);
            }
        }, function (error) {
            console.error("Error fetching bill: ", error);
            alert("æŸ¥è¯¢å•æ®æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        });
    }

    function showModal(data, currentBill) {
        // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†
        const modal = document.createElement("div");
        modal.id = "modalContainer";
        modal.classList.add("modal");

        // æ·»åŠ å•æ®å†…å®¹
        const content = document.createElement("pre");
        content.style.color = "black";
        content.style.margin = "0";
        content.style.whiteSpace = "pre-wrap"; // è‡ªåŠ¨æ¢è¡Œ
        content.textContent = data;
        modal.appendChild(content);

        // æ·»åŠ æŒ‰é’®å®¹å™¨
        const buttonContainer = document.createElement("div");
        buttonContainer.style.display = "flex";
        buttonContainer.style.justifyContent = "space-between";
        buttonContainer.style.marginTop = "20px";

        // æ·»åŠ "å‰ä¸€å¼ "æŒ‰é’®
        const prevButton = document.createElement("button");
        prevButton.textContent = "Previous Bill";
        prevButton.style.backgroundColor = "#007bff";
        prevButton.style.color = "white";
        prevButton.style.padding = "10px";
        prevButton.style.border = "none";
        prevButton.style.borderRadius = "5px";
        prevButton.style.cursor = "pointer";
        prevButton.onclick = function () {
            const prevBillNumber = parseInt(currentBill) - 1;
            if (prevBillNumber < 1) {
                alert("No previous bill found.");
                return;
            }
            const prevBillKey = prevBillNumber.toString().padStart(3, "0");
            database.ref(`stores/${selectedStore}/bills/${prevBillKey}`).once('value', function (prevSnapshot) {
                if (prevSnapshot.exists()) {
                    document.body.removeChild(modal); // å…³é—­å½“å‰æ¨¡æ€æ¡†
                    const prevBillData = prevSnapshot.val();
                    const prevBillText = `
Store: ${prevBillData.store}
Supervisor: ${prevBillData.supervisor}
Cashier: ${prevBillData.cashier}

Bill No: ${prevBillData.billNumber}
Payment: ${prevBillData.paymentMethod}

${Object.values(prevBillData.items).map(item => `${item.name} - ${item.quantity} pc, RM${(item.quantity * item.price).toFixed(2)}`).join('\n')}

Total: RM${prevBillData.total.toFixed(2)}

Date: ${new Date(prevBillData.date).toLocaleDateString()}
Time: ${new Date(prevBillData.date).toLocaleTimeString()}
                        `;
                    showModal(prevBillText, prevBillKey);
                } else {
                    alert("No previous bill found.");
                }
            }, function (error) {
                console.error("Error fetching previous bill: ", error);
                alert("æŸ¥è¯¢å‰ä¸€å¼ å•æ®æ—¶å‡ºé”™ã€‚");
            });
        };
        buttonContainer.appendChild(prevButton);

        // æ·»åŠ "åä¸€å¼ "æŒ‰é’®
        const nextButton = document.createElement("button");
        nextButton.textContent = "Next Bill";
        nextButton.style.backgroundColor = "#007bff";
        nextButton.style.color = "white";
        nextButton.style.padding = "10px";
        nextButton.style.border = "none";
        nextButton.style.borderRadius = "5px";
        nextButton.style.cursor = "pointer";
        nextButton.onclick = function () {
            const nextBillNumber = parseInt(currentBill) + 1;
            const nextBillKey = nextBillNumber.toString().padStart(3, "0");
            database.ref(`stores/${selectedStore}/bills/${nextBillKey}`).once('value', function (nextSnapshot) {
                if (nextSnapshot.exists()) {
                    document.body.removeChild(modal); // å…³é—­å½“å‰æ¨¡æ€æ¡†
                    const nextBillData = nextSnapshot.val();
                    const nextBillText = `
Store: ${nextBillData.store}
Supervisor: ${nextBillData.supervisor}
Cashier: ${nextBillData.cashier}

Bill No: ${nextBillData.billNumber}
Payment: ${nextBillData.paymentMethod}

${Object.values(nextBillData.items).map(item => `${item.name} - ${item.quantity} pc, RM${(item.quantity * item.price).toFixed(2)}`).join('\n')}

Total: RM${nextBillData.total.toFixed(2)}

Date: ${new Date(nextBillData.date).toLocaleDateString()}
Time: ${new Date(nextBillData.date).toLocaleTimeString()}
                        `;
                    showModal(nextBillText, nextBillKey);
                } else {
                    alert("No next bill found.");
                }
            }, function (error) {
                console.error("Error fetching next bill: ", error);
                alert("æŸ¥è¯¢åä¸€å¼ å•æ®æ—¶å‡ºé”™ã€‚");
            });
        };
        buttonContainer.appendChild(nextButton);

        modal.appendChild(buttonContainer);

        // æ·»åŠ å…³é—­æŒ‰é’®
        const closeButton = document.createElement("button");
        closeButton.textContent = "Close";
        closeButton.classList.add("close-button");
        closeButton.onclick = function () {
            document.body.removeChild(modal);
        };

        modal.appendChild(closeButton);

        // æ·»åŠ æ¨¡æ€æ¡†åˆ° body
        document.body.appendChild(modal);
        modal.style.display = "block";
    }

    function deleteBill() {
        const billInput = document.getElementById("billSearchInput").value.trim();
        if (billInput === "") {
            alert("Please enter a valid bill number.");
            return;
        }

        const billKey = billInput.padStart(3, "0"); // ç¡®ä¿æ˜¯ä¸‰ä½æ•°ï¼Œå¦‚ 001

        if (!selectedStore) {
            alert("Please select a store before deleting bills.");
            return;
        }

        const billRef = database.ref(`stores/${selectedStore}/bills/${billKey}`);

        billRef.once('value', function (snapshot) {
            if (snapshot.exists()) {
                const billData = snapshot.val();

                const confirmDelete = confirm(`Are you sure you want to delete bill ${billInput}?`);
                if (confirmDelete) {
                    // å…ˆæ›´æ–° salesSummary å’Œ soldItems
                    const paymentMethod = billData.paymentMethod;
                    const total = billData.total;
                    const items = billData.items;

                    // æ›´æ–° salesSummary
                    const salesSummaryRef = database.ref(`stores/${selectedStore}/salesSummary`);
                    salesSummaryRef.once('value', function (summarySnapshot) {
                        let summaryData = summarySnapshot.val();
                        if (!summaryData) {
                            summaryData = { cash: 0, card: 0, ewallet: 0 };
                        }

                        if (paymentMethod === "Cash") {
                            summaryData.cash -= total;
                            if (summaryData.cash < 0) summaryData.cash = 0; // é˜²æ­¢è´Ÿæ•°
                        } else if (paymentMethod === "Card") {
                            summaryData.card -= total;
                            if (summaryData.card < 0) summaryData.card = 0;
                        } else if (paymentMethod === "E-Wallet") {
                            summaryData.ewallet -= total;
                            if (summaryData.ewallet < 0) summaryData.ewallet = 0;
                        }

                        // æ›´æ–° salesSummary
                        salesSummaryRef.set(summaryData, function (error) {
                            if (error) {
                                console.error("Error updating sales summary: ", error);
                                alert("åˆ é™¤å•æ®æ—¶æ›´æ–°é”€å”®æ‘˜è¦å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚");
                                return;
                            }

                            // æ›´æ–° soldItems
                            const soldItemsRef = database.ref(`stores/${selectedStore}/soldItems`);
                            const updateSoldItemsPromises = [];

                            for (const itemId in items) {
                                const item = items[itemId];
                                const itemNameKey = item.name.replace(/\s+/g, '_'); // ç”¨ä¸‹åˆ’çº¿æ›¿ä»£ç©ºæ ¼

                                const itemRef = soldItemsRef.child(itemNameKey);
                                const promise = itemRef.once('value').then(function (itemSnapshot) {
                                    if (itemSnapshot.exists()) {
                                        const currentItemData = itemSnapshot.val();
                                        currentItemData.quantity -= item.quantity;
                                        currentItemData.totalPrice -= item.quantity * item.price;

                                        // ç¡®ä¿ä¸ä¼šå‡ºç°è´Ÿæ•°
                                        if (currentItemData.quantity < 0) currentItemData.quantity = 0;
                                        if (currentItemData.totalPrice < 0) currentItemData.totalPrice = 0;

                                        // å¦‚æœå•†å“æ•°é‡å’Œæ€»ä»·éƒ½ä¸ºé›¶ï¼Œåˆ™åˆ é™¤è¯¥å•†å“è®°å½•
                                        if (currentItemData.quantity === 0 && currentItemData.totalPrice === 0) {
                                            return itemRef.remove();
                                        } else {
                                            return itemRef.set(currentItemData);
                                        }
                                    }
                                }).catch(function (error) {
                                    console.error(`Error updating sold item ${item.name}: `, error);
                                });

                                updateSoldItemsPromises.push(promise);
                            }

                            // ç­‰å¾…æ‰€æœ‰ soldItems æ›´æ–°å®Œæˆ
                            Promise.all(updateSoldItemsPromises).then(function () {
                                // æœ€ååˆ é™¤å•æ®
                                billRef.remove(function (error) {
                                    if (error) {
                                        console.error("Error deleting bill: ", error);
                                        alert("åˆ é™¤å•æ®æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚");
                                    } else {
                                        alert(`Bill ${billInput} deleted successfully.`);

                                        // å¦‚æœå½“å‰æ˜¾ç¤ºçš„å•æ®æ˜¯è¢«åˆ é™¤çš„å•æ®ï¼Œå¯ä»¥æ¸…é™¤æ˜¾ç¤º
                                        document.getElementById("result").innerText = "";
                                        document.getElementById("productList").innerHTML = "";
                                        selectedItems = {};
                                        togglePaymentMethod(false);
                                        hideCashInput();
                                        toggleItems();
                                        updateCurrentBillDisplay(); // å¯é€‰ï¼šæ›´æ–°å½“å‰å•æ®æ˜¾ç¤º
                                    }
                                });
                            });
                        });
                    }, function (error) {
                        console.error("Error fetching sales summary: ", error);
                        alert("åˆ é™¤å•æ®æ—¶è·å–é”€å”®æ‘˜è¦å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚");
                    });
                }
            } else {
                alert(`Bill ${billInput} not found.`);
            }
        }, function (error) {
            console.error("Error fetching bill: ", error);
            alert("æŸ¥è¯¢å•æ®æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        });
    }

    function togglePaymentMethod(show) {
        const paymentSection = document.querySelector(".payment-section");
        if (show) {
            paymentSection.style.display = "block"; // æ˜¾ç¤ºæ”¯ä»˜æ–¹å¼
        } else {
            paymentSection.style.display = "none"; // éšè—æ”¯ä»˜æ–¹å¼
        }
    }

    function showSalesClosing() {
        if (!selectedStore) {
            alert("Please select a store before viewing sales closing.");
            return;
        }

        const salesSummaryRef = database.ref(`stores/${selectedStore}/salesSummary`);
        const soldItemsRef = database.ref(`stores/${selectedStore}/soldItems`);

        // Fetch sales summary
        salesSummaryRef.once('value', function (summarySnapshot) {
            const summaryData = summarySnapshot.val() || { cash: 0, card: 0, ewallet: 0 };
            const totalSales = summaryData.cash + summaryData.card + summaryData.ewallet;

            // Fetch sold items
            soldItemsRef.orderByChild('quantity').once('value', function (itemsSnapshot) {
                const itemsData = itemsSnapshot.val() || {};
                // Convert to array and sort by quantity descending
                const sortedItems = Object.entries(itemsData).sort((a, b) => b[1].quantity - a[1].quantity);

                // Create modal content
                const modal = document.createElement("div");
                modal.classList.add("modal");

                const content = document.createElement("div");
                content.style.color = "black";

                // å•†å“æ’åºï¼šæŒ‰è´­ä¹°æ•°é‡é™åº
                let itemDetails = "";
                sortedItems.forEach(([itemName, item]) => {
                    itemDetails += `<p>${itemName.replace(/_/g, ' ')} - Quantity: ${item.quantity}, Total: RM${item.totalPrice.toFixed(2)}</p>`;
                });

                content.innerHTML = `
                    <h3>Sales Closing</h3>
                    <p><strong>Store:</strong> ${selectedStore}</p>
                    <p><strong>Supervisor:</strong> ${supervisorName}</p>
                    <p><strong>Cashier:</strong> ${cashierName}</p>
                    <p><strong>Cash:</strong> RM${summaryData.cash.toFixed(2)}</p>
                    <p><strong>Card:</strong> RM${summaryData.card.toFixed(2)}</p>
                    <p><strong>E-Wallet:</strong> RM${summaryData.ewallet.toFixed(2)}</p>
                    <p><strong>Total Sales:</strong> RM${totalSales.toFixed(2)}</p>
                    <h4>Sold Items (Sorted by Quantity):</h4>
                    ${itemDetails}
                `;
                modal.appendChild(content);

                // æ·»åŠ å…³é—­æŒ‰é’®
                const closeButton = document.createElement("button");
                closeButton.textContent = "Close";
                closeButton.classList.add("close-button");
                closeButton.onclick = function () {
                    document.body.removeChild(modal);
                };
                modal.appendChild(closeButton);

                // æ·»åŠ æ¨¡æ€æ¡†åˆ° body
                document.body.appendChild(modal);
                modal.style.display = "block";
            }, function (error) {
                console.error("Error fetching sold items: ", error);
                alert("è·å–å”®å‡ºç‰©å“æ•°æ®æ—¶å‡ºé”™ã€‚");
            });
        }, function (error) {
            console.error("Error fetching sales summary: ", error);
            alert("è·å–é”€å”®æ‘˜è¦æ•°æ®æ—¶å‡ºé”™ã€‚");
        });
    }
</script>

    <p class="contact-info">If you have any questions or need to add new products, please contact me (Mark).</p>

    <!-- Supervisor å’Œ Cashier è¾“å…¥æ¨¡æ€æ¡† -->
    <div id="supervisorModal" class="modal">
        <h3 style="text-align: center; color: black;">Enter Supervisor and Cashier</h3>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px;">
            <input id="supervisorInput" type="text" placeholder="Supervisor Name" style="width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
            <input id="cashierInput" type="text" placeholder="Cashier Name" style="width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;">
            <button onclick="submitSupervisorAndCashier()" style="width: 200px; height: 50px; font-size: 16px; background-color: black; color: white; border: none; border-radius: 5px; cursor: pointer;">Submit</button>
        </div>
    </div>

    <!-- åº—é“ºé€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="storeModal" class="modal">
        <h3 style="text-align: center; color: black;">Select Store</h3>
        <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; margin-top: 20px;">
            <button onclick="selectStore('JKL')" style="width: 200px; height: 50px; font-size: 16px; background-color: black; color: white; border: none; border-radius: 5px; cursor: pointer;">JKL</button>
            <button onclick="selectStore('TOM')" style="width: 200px; height: 50px; font-size: 16px; background-color: black; color: white; border: none; border-radius: 5px; cursor: pointer;">TOM</button>
            <button onclick="selectStore('Ole-Ole')" style="width: 200px; height: 50px; font-size: 16px; background-color: black; color: white; border: none; border-radius: 5px; cursor: pointer;">Ole-Ole</button>
            <!-- æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šåº—é“ºæŒ‰é’® -->
        </div>
    </div>

</body>

</html>
